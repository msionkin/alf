(function(){var c=YAHOO.util.Dom,t=YAHOO.util.Event;var p=Alfresco.util.encodeHTML;Alfresco.Search=function(u){Alfresco.Search.superclass.constructor.call(this,"Alfresco.Search",u,["button","container","datasource","datatable","paginator","json"]);YAHOO.Bubbling.on("onSearch",this.onSearch,this);return this};YAHOO.extend(Alfresco.Search,Alfresco.component.SearchBase,{options:{siteId:"",siteTitle:"",maxSearchResults:250,pageSize:50,initialSearchTerm:"",initialSearchTag:"",initialSearchAllSites:true,initialSearchRepository:false,initialSort:"",searchQuery:"",searchRootNode:"",minSearchTermLength:1},searchTerm:"",searchTag:"",searchAllSites:true,searchRepository:false,searchSort:"",resultsCount:0,currentPage:1,hasMoreResults:false,onReady:function q(){var C=this;var v=Alfresco.constants.PROXY_URI_RELATIVE+"slingshot/search?";this.widgets.dataSource=new YAHOO.util.DataSource(v,{responseType:YAHOO.util.DataSource.TYPE_JSON,connXhrMode:"queueRequests",responseSchema:{resultsList:"items",metaFields:{paginationRecordOffset:"startIndex",totalRecords:"totalRecords",totalRecordsUpper:"totalRecordsUpper"}}});var y=function B(F,E){E.currentPage=F.page;E.widgets.paginator.setState(F);E._performSearch({searchTerm:E.searchTerm,searchTag:E.searchTag,searchAllSites:E.searchAllSites,searchRepository:E.searchRepository,searchSort:E.searchSort,page:E.currentPage})};this.widgets.paginator=new YAHOO.widget.Paginator({containers:[this.id+"-paginator-top",this.id+"-paginator-bottom"],rowsPerPage:this.options.pageSize,initialPage:1,template:this.msg("pagination.template"),pageReportTemplate:this.msg("pagination.template.page-report"),previousPageLinkLabel:this.msg("pagination.previousPageLinkLabel"),nextPageLinkLabel:this.msg("pagination.nextPageLinkLabel")});this.widgets.paginator.subscribe("changeRequest",y,this);this._setupDataTable();var x=c.get(this.id+"-search-text");x.value=this.options.initialSearchTerm;this.widgets.enterListener=new YAHOO.util.KeyListener(x,{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:C._searchEnterHandler,scope:this,correctScope:true},"keydown").enable();YAHOO.Bubbling.fire("onSearch",{searchTerm:this.options.initialSearchTerm,searchTag:this.options.initialSearchTag,searchSort:this.options.initialSort,searchAllSites:this.options.initialSearchAllSites,searchRepository:this.options.initialSearchRepository});var A=c.get(this.id+"-site-link");t.addListener(A,"click",this.onSiteSearch,this,true);A=c.get(this.id+"-all-sites-link");t.addListener(A,"click",this.onAllSiteSearch,this,true);A=c.get(this.id+"-repo-link");t.addListener(A,"click",this.onRepositorySearch,this,true);this.widgets.searchButton=Alfresco.util.createYUIButton(this,"search-button",this.onSearchClick);this.widgets.sortButton=new YAHOO.widget.Button(this.id+"-sort-menubutton",{type:"menu",menu:this.id+"-sort-menu",menualignment:["tr","br"],lazyloadmenu:false});var u=this.widgets.sortButton.getMenu().getItems();for(var w in u){if(u[w].value===this.options.initialSort){this.widgets.sortButton.set("label",this.msg("label.sortby",u[w].cfg.getProperty("text")));break}}this.widgets.sortButton.getMenu().subscribe("click",function(F,E){var G=E[1];if(G){C.refreshSearch({searchSort:G.value})}});var D=function z(G,F){var E=YAHOO.Bubbling.getOwnerByTagName(F[1].anchor,"span");if(E!==null){if(typeof C[E.className]=="function"){F[1].stop=true;var H=E.id.substring(C.id.length+1);C[E.className].call(C,H)}}return true};YAHOO.Bubbling.addDefaultAction("search-tag",D);c.setStyle(this.id+"-body","visibility","visible")},_setupDataTable:function f(){var y=this;renderCellThumbnail=function x(B,A,C,D){C.width=100;c.setStyle(B.parentNode,"width",C.width+"px");c.setStyle(B.parentNode,"background-color","#f4f4f4");c.addClass(B,"thumbnail-cell");if(A.getData("type")==="document"){c.addClass(B,"thumbnail")}B.innerHTML=y.buildThumbnailHtml(A)};renderCellDescription=function v(L,O,H,C){c.addClass(L.parentNode,"description");var A=O.getData("site");var B=y._getBrowseUrlForRecord(O);var K=O.getData("displayName");var G='<h3 class="itemname"><a href="'+B+'" class="theme-color-1">'+p(K)+"</a>";var J=O.getData("title");if(J&&J!==K){G+='<span class="title">('+p(J)+")</span>"}G+="</h3>";var F=O.getData("description");if(F){G+='<div class="details meta">'+p(F)+"</div>"}G+='<div class="details">';var I=O.getData("type");G+=y.buildTextForType(I);if(A){G+=" "+y.msg("message.insite");G+=' <a href="'+Alfresco.constants.URL_PAGECONTEXT+"site/"+p(A.shortName)+'/dashboard">'+p(A.title)+"</a>"}if(O.getData("size")!==-1){G+=" "+y.msg("message.ofsize");G+=' <span class="meta">'+Alfresco.util.formatFileSize(O.getData("size"))+"</span>"}if(O.getData("modifiedBy")){G+=" "+y.msg("message.modifiedby");G+=' <a href="'+Alfresco.constants.URL_PAGECONTEXT+"user/"+encodeURI(O.getData("modifiedByUser"))+'/profile">'+p(O.getData("modifiedBy"))+"</a>"}G+=" "+y.msg("message.modifiedon")+' <span class="meta">'+Alfresco.util.formatDate(O.getData("modifiedOn"))+"</span>";G+="</div>";var N=O.getData("path");G+=y.buildPath(I,N,A);var M=O.getData("tags");if(M.length!==0){var E,D;G+='<div class="details"><span class="tags">';for(E=0,D=M.length;E<D;E++){G+='<span id="'+y.id+"-"+p(M[E])+'" class="searchByTag"><a class="search-tag" href="#">'+p(M[E])+"</a> </span>"}G+="</span></div>"}L.innerHTML=G};var z=[{key:"image",label:y.msg("message.preview"),sortable:false,formatter:renderCellThumbnail,width:100},{key:"summary",label:y.msg("label.description"),sortable:false,formatter:renderCellDescription}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-results",z,this.widgets.dataSource,{renderLoopSize:Alfresco.util.RENDERLOOPSIZE,initialLoad:false,paginator:this.widgets.paginator,MSG_LOADING:""});this._setDefaultDataTableErrors(this.widgets.dataTable);if(this.options.initialSearchTerm.length===0&&this.options.initialSearchTag.length===0){this.widgets.dataTable.set("MSG_EMPTY","")}this.widgets.dataTable.doBeforeLoadData=function w(B,C,E){if(C.error){try{var A=YAHOO.lang.JSON.parse(C.responseText);y.widgets.dataTable.set("MSG_ERROR",A.message)}catch(D){y._setDefaultDataTableErrors(y.widgets.dataTable)}}else{if(C.results){y.widgets.dataTable.set("MSG_EMPTY","");if(C.results.length===0){c.removeClass(y.id+"-help","hidden")}}}return true};y.widgets.dataTable.handleDataReturnPayload=function u(B,A,C){y.resultsCount=A.meta.totalRecordsUpper;if(y.hasMoreResults=(y.resultsCount>y.options.maxSearchResults)){y.resultsCount=y.options.maxSearchResults}if(y.resultsCount>y.options.pageSize){c.removeClass(y.id+"-paginator-top","hidden");c.removeClass(y.id+"-search-bar-bottom","hidden")}return A.meta};y.widgets.dataTable.subscribe("renderEvent",function(){y.widgets.paginator.setState({page:y.currentPage,totalRecords:y.resultsCount});y.widgets.paginator.render()})},_getBrowseUrlForRecord:function j(u){return this.getBrowseUrlForRecord(u)},_getBrowseUrlForFolderPath:function l(v,u){return this.getBrowseUrlForFolderPath(v,u)},_buildSpaceNamePath:function n(v,u){return this.buildSpaceNamePath(v,u)},searchByTag:function r(u){this.refreshSearch({searchTag:u,searchTerm:"",searchQuery:""})},refreshSearch:function g(x){var v=this.searchTerm;if(x.searchTerm!==undefined){v=x.searchTerm}var y=this.searchTag;if(x.searchTag!==undefined){y=x.searchTag}var A=this.searchAllSites;if(x.searchAllSites!==undefined){A=x.searchAllSites}var B=this.searchRepository;if(x.searchRepository!==undefined){B=x.searchRepository}var u=this.searchSort;if(x.searchSort!==undefined){u=x.searchSort}var z=this.options.searchQuery;if(x.searchQuery!==undefined){z=x.searchQuery}var w=Alfresco.constants.URL_PAGECONTEXT;if(this.options.siteId.length!==0){w+="site/"+this.options.siteId+"/"}w+="search?t="+encodeURIComponent(v);w+="&s="+u;if(z.length!==0){w+="&q="+z}else{if(y.length!==0){w+="&tag="+encodeURIComponent(y)}}w+="&a="+A+"&r="+B;window.location=w},onSearch:function i(y,w){var B=w[1];if(B!==null){var v=this.searchTerm;if(B.searchTerm!==undefined){v=B.searchTerm}var x=this.searchTag;if(B.searchTag!==undefined){x=B.searchTag}var z=this.searchAllSites;if(B.searchAllSites!==undefined){z=B.searchAllSites}var A=this.searchRepository;if(B.searchRepository!==undefined){A=B.searchRepository}var u=this.searchSort;if(B.searchSort!==undefined){u=B.searchSort}this._performSearch({searchTerm:v,searchTag:x,searchAllSites:z,searchRepository:A,searchSort:u})}},onSearchClick:function d(v,u){this.refreshSearch({searchTag:"",searchTerm:YAHOO.lang.trim(c.get(this.id+"-search-text").value),searchQuery:""})},onSiteSearch:function k(v,u){this.refreshSearch({searchAllSites:false,searchRepository:false})},onAllSiteSearch:function s(v,u){this.refreshSearch({searchAllSites:true,searchRepository:false})},onRepositorySearch:function h(v,u){this.refreshSearch({searchRepository:true})},_searchEnterHandler:function m(v,u){this.refreshSearch({searchTag:"",searchTerm:YAHOO.lang.trim(c.get(this.id+"-search-text").value),searchQuery:""})},_performSearch:function a(B){var w=YAHOO.lang.trim(B.searchTerm),x=YAHOO.lang.trim(B.searchTag),C=B.searchAllSites,v=B.searchRepository,y=B.searchSort,A=B.page||1;if(this.options.searchQuery.length===0&&x.length===0&&w.replace(/\*/g,"").length<this.options.minSearchTermLength){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.minimum-length",this.options.minSearchTermLength)});return}this.widgets.dataTable.deleteRows(0,this.widgets.dataTable.getRecordSet().getLength());c.addClass(this.id+"-paginator-top","hidden");c.addClass(this.id+"-search-bar-bottom","hidden");c.get(this.id+"-search-info").innerHTML=this.msg("search.info.searching");this.widgets.dataTable.set("MSG_EMPTY","");this.widgets.dataTable.render();function z(D,E,F){this.searchTerm=w;this.searchTag=x;this.searchAllSites=C;this.searchRepository=v;this.searchSort=y;this.widgets.dataTable.onDataReturnInitializeTable.call(this.widgets.dataTable,D,E,F);this._updateResultsInfo();c.get(this.id+"-search-text").focus()}function u(E,F){switch(F.status){case 401:window.location.reload();break;case 408:c.get(this.id+"-search-info").innerHTML=this.msg("message.timeout");break;default:if(F.responseText){var D=YAHOO.lang.JSON.parse(F.responseText);c.get(this.id+"-search-info").innerHTML=D.message}else{c.get(this.id+"-search-info").innerHTML=F.statusText}break}}this.widgets.dataSource.sendRequest(this._buildSearchParams(v,C,w,x,y,A),{success:z,failure:u,scope:this})},_updateResultsInfo:function e(){var v;var u=""+this.resultsCount;if(this.hasMoreResults){v=this.msg("search.info.resultinfomore",u)}else{v=this.msg("search.info.resultinfo",u)}if(this.searchRepository||this.options.searchQuery.length!==0){v+=" "+this.msg("search.info.foundinrepository")}else{if(this.searchAllSites){v+=" "+this.msg("search.info.foundinallsite")}else{v+=" "+this.msg("search.info.foundinsite",p(this.options.siteTitle))}}c.get(this.id+"-search-info").innerHTML=v},_buildSearchParams:function b(A,z,v,x,u,y){var w=z?"":this.options.siteId;var B=YAHOO.lang.substitute("site={site}&term={term}&tag={tag}&maxResults={maxResults}&sort={sort}&query={query}&repo={repo}&rootNode={rootNode}&pageSize={pageSize}&startIndex={startIndex}",{site:encodeURIComponent(w),repo:A.toString(),term:encodeURIComponent(v),tag:encodeURIComponent(x),sort:encodeURIComponent(u),query:encodeURIComponent(this.options.searchQuery),rootNode:encodeURIComponent(this.options.searchRootNode),maxResults:this.options.maxSearchResults+1,pageSize:this.options.pageSize,startIndex:(y-1)*this.options.pageSize});return B},_setDefaultDataTableErrors:function o(u){var v=Alfresco.util.message;u.set("MSG_EMPTY",v("message.empty","Alfresco.Search"));u.set("MSG_ERROR",v("message.error","Alfresco.Search"))}})})();