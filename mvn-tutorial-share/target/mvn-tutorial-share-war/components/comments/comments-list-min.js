(function(){var a=YAHOO.util.Dom,s=YAHOO.util.Selector;var q=Alfresco.util.encodeHTML,d=Alfresco.util.userProfileLink,c=Alfresco.Share.userAvatar;Alfresco.CommentsList=function p(x){Alfresco.CommentsList.superclass.constructor.call(this,"Alfresco.CommentsList",x,["datasource","datatable","paginator","history","animation"]);YAHOO.Bubbling.on("editorInitialized",this.onEditorInitialized,this);YAHOO.Bubbling.on("commentNode",this.onCommentNode,this);YAHOO.Bubbling.on("versionReverted",function(){this.widgets.alfrescoDataTable.reloadDataTable()},this);this.busy=false;this.hashChecked=false;return this};YAHOO.extend(Alfresco.CommentsList,Alfresco.component.Base,{options:{nodeRef:null,siteId:null,activity:null,editorConfig:{}},busy:null,hashChecked:null,onReady:function m(){var x=document.createElement("div");a.addClass(x,"comments-list");a.addClass(x,"hidden");a.get(this.id+"-body").appendChild(x);this.widgets.editFormWrapper=x;YAHOO.util.Event.addListener(window,"resize",function(){if(this.currentEditedRowId){this.synchronizeElements(this.widgets.editFormWrapper,this.currentEditedRowId+"-form-container")}},this,true);this.setupCommentList();this.setupAddCommentForm()},setupCommentList:function w(){var x=Alfresco.constants.URL_SERVICECONTEXT+"components/node/"+this.options.nodeRef.replace(":/","")+"/comments?reverse=true";this.widgets.alfrescoDataTable=new Alfresco.util.DataTable({dataSource:{url:x,pagingResolver:function(y,z){return"startIndex="+y+"&pageSize="+z},config:{responseSchema:{resultsList:"items",metaFields:{paginationRecordOffset:"startIndex",paginationRowsPerPage:"pageSize",totalRecords:"total"}}},doBeforeParseData:this.bind(this.handlePermissions)},dataTable:{container:this.id+"-comments-list",columnDefinitions:[{key:"comment",sortable:false,formatter:this.bind(this.renderCellComment)}],config:{MSG_EMPTY:this.msg("message.noComments")}},paginator:{history:false,config:{containers:[this.id+"-paginator-top",this.id+"-paginator-bottom"],rowsPerPage:this.options.maxItems}}});this.widgets.alfrescoDataTable.getDataTable().subscribe("beforeRenderEvent",function(){a.removeClass(s.query("hr.hidden"),"hidden")},this,this)},handlePermissions:function e(z,x){var y=x.nodePermissions||{};if(y.create){a.removeClass(this.id+"-actions","hidden")}return x},setupAddCommentForm:function k(){a.get(this.id+"-add-form-container").innerHTML=this.formMarkup(this.id+"-add",Alfresco.constants.USERNAME,null);this.widgets.addCommentEditor=this.setupCommentForm(this.id+"-add",this.options.nodeRef,false).editor},setupCommentForm:function f(B,F,x){var G=B+"-form",E=a.get(B+"-form-container"),z;if(x){z="api/comment/node/"+F.replace(":/","")}else{z="api/node/"+F.replace(":/","")+"/comments"}a.get(G).setAttribute("action",Alfresco.constants.PROXY_URI+z);var C=new YAHOO.widget.Button(B+"-submit",{type:"submit"});C.set("label",this.msg(x?"button.save":"button.addComment"));var A=new YAHOO.widget.Button(B+"-cancel");A.subscribe("click",function(){if(this.widgets.commentForm!=null){this.widgets.commentForm.hideErrorContainer()}this.restoreEditForm()},this,true);A.set("label",this.msg("button.cancel"));var D=new Alfresco.util.RichEditor(Alfresco.constants.HTML_EDITOR,B+"-content",this.options.editorConfig);this.widgets.editor=D;D.addPageUnloadBehaviour(this.msg("message.unsavedChanges.comment"));D.render();var I=(Alfresco.constants.HTML_EDITOR==="YAHOO.widget.SimpleEditor")?"editorKeyUp":"onKeyUp";this.widgets.editor.subscribe(I,function(J){if(this.widgets.editor.getContent().length<20||!this.widgets.commentForm.isValid()){this.widgets.editor.save();this.widgets.commentForm.validate()}},this,true);if(YAHOO.env.ua.ie>0){D.subscribe("onPaste",function(J,K){D.setContent("work around");D.save()})}if(this.widgets.commentForm!=null){this.widgets.commentForm.hideErrorContainer()}var y=new Alfresco.forms.Form(G);this.widgets.commentForm=y;y.addValidation(B+"-content",Alfresco.forms.validation.mandatory,null);y.setSubmitElements(C);y.setAjaxSubmitMethod(x?Alfresco.util.Ajax.PUT:Alfresco.util.Ajax.POST);y.setAJAXSubmit(true,{successCallback:{fn:function H(J,K){this.restoreEditForm();a.addClass(E,"hidden");this._releaseBusy();this.widgets.alfrescoDataTable.reloadDataTable();A.set("disabled",false)},scope:this},failureMessage:this.msg("message.savecomment.failure"),failureCallback:{fn:function H(J,K){this._releaseBusy();A.set("disabled",false)},scope:this}});y.setSubmitAsJSON(true);y.doBeforeFormSubmit={fn:function(J){this._setBusy(this.msg("message.wait"));A.set("disabled",true);D.save();D.getEditor().undoManager.clear();D.getEditor().nodeChanged()},scope:this};y.doBeforeAjaxRequest={fn:function(J,K){if(this.options.activity){J.dataObj.itemTitle=this.options.activity.itemTitle;J.dataObj.page=this.options.activity.page;J.dataObj.pageParams=YAHOO.lang.JSON.stringify(this.options.activity.pageParams)}return true},scope:this};y.init();return{form:y,editor:D}},restoreEditForm:function l(){if(this.currentEditedRowId){var y=a.get(this.currentEditedRowId+"-form-container"),x=a.get(this.currentEditedRowId+"-comment-container");if(y&&x){a.removeClass(y.parentNode,"theme-bg-color-4");a.addClass(y,"hidden");a.removeClass(x,"hidden");a.addClass(this.widgets.editFormWrapper,"hidden")}}a.addClass(this.id+"-add-form-container","hidden");a.removeClass(this.widgets.onAddCommentClick.get("element"),"hidden")},renderCellComment:function b(B,z,D,E){var A=z.getData(),x="",C=this.id+"-"+z.getId(),y=A.permissions;x+='<div id="'+C+'-comment-container" class="comment-details">';x+='   <div class="icon">'+c(A.author.username)+"</div>";x+='   <div class="details">';x+='      <span class="info">';x+=d(A.author.username,A.author.firstName+" "+A.author.lastName,'class="theme-color-1"')+" ";x+=Alfresco.util.relativeTime(Alfresco.util.fromISO8601(A.modifiedOnISO))+"<br/>";x+="      </span>";x+='      <span class="comment-actions">';if(y.edit){x+='       <a href="#" name=".onEditCommentClick" rel="'+z.getId()+'" title="'+this.msg("link.editComment")+'" class="'+this.id+' edit-comment">&nbsp;</a>'}if(y["delete"]){x+='       <a href="#" name=".onConfirmDeleteCommentClick" rel="'+z.getId()+'" title="'+this.msg("link.deleteComment")+'" class="'+this.id+' delete-comment">&nbsp;</a>'}x+="      </span>";x+='      <div class="comment-content">'+(A.content||"")+"</div>";x+="   </div>";x+='   <div class="clear"></div>';x+="</div>";x+='<div id="'+C+'-form-container" class="comment-form hidden">';x+="   &nbsp;<!-- EMPTY SPACE FOR FLOATING COMMENT FORM -->";x+="</div>";B.innerHTML=x},formMarkup:function n(z,y,A){var x="";x+='<div id="'+z+'-actual-form-container" class="comment-form">';x+='   <h2 class="thin dark">'+this.msg(A?"header.edit":"header.add")+"</h2>";x+=c(y);x+='   <form id="'+z+'-form" method="POST" action="">';if(this.options.siteId){x+='      <input type="hidden" name="site" value="'+this.options.siteId+'" />'}x+='      <textarea name="content" id="'+z+'-content" style="width: 100%">'+(A||"")+"</textarea>";x+='      <div class="buttons">';x+='         <input type="submit" id="'+z+'-submit" value=""/>';x+='         <input type="reset"  id="'+z+'-cancel" value="" />';x+="      </div>";x+="   </form>";x+='   <div class="clear"></div>';x+="</div>";return x},onEditorInitialized:function i(){if(!this.hashChecked&&window.location.hash=="#comment"){this.hashChecked=true;this.onAddCommentClick(true);a.get(this.id+"-add-comment").scrollIntoView()}},onCommentNode:function u(y,x){if(this.options.nodeRef==x[1]){this.onAddCommentClick();a.get(this.id+"-add-comment").scrollIntoView()}},onAddCommentClick:function o(x){this.restoreEditForm();if(x==null){this.setupAddCommentForm()}a.addClass(this.widgets.onAddCommentClick.get("element"),"hidden");this.widgets.addCommentEditor.setContent("");this.widgets.addCommentEditor.save();a.removeClass(this.id+"-add-form-container","hidden");this.widgets.addCommentEditor.focus()},onEditCommentClick:function r(x){this.restoreEditForm();var B=this.widgets.alfrescoDataTable.getData(x),z=this.id+"-"+x,y=a.get(z+"-form-container"),A=a.get(z+"-comment-container");this.currentEditedRowId=z;a.addClass(y.parentNode,"theme-bg-color-4");a.addClass(A,"hidden");a.removeClass(y,"hidden");this.widgets.editFormWrapper.innerHTML=this.formMarkup(z,B.author.username,B.content);this.setupCommentForm(z,B.nodeRef,true);this.synchronizeElements(this.widgets.editFormWrapper,y);a.removeClass(this.widgets.editFormWrapper,"hidden")},synchronizeElements:function v(A,x){var z=new YAHOO.util.Element(x),y=new YAHOO.util.Element(A),B=YAHOO.util.Dom.getRegion(z.get("id"));y.setStyle("position","absolute");y.setStyle("left",B.left+"px");y.setStyle("top",B.top+"px");y.setStyle("width",B.width+"px");y.setStyle("height",B.height+"px")},onConfirmDeleteCommentClick:function t(z){var B=this.widgets.alfrescoDataTable.getData(z),A=this;Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.confirm.delete.title"),text:this.msg("message.confirm.delete"),buttons:[{text:this.msg("button.delete"),handler:function y(){this.destroy();A.deleteComment.call(A,B)}},{text:this.msg("button.cancel"),handler:function x(){this.destroy()},isDefault:true}]})},deleteComment:function j(D){if(!this._setBusy(this.msg("message.wait"))){return}var C=function A(E,G){this._releaseBusy();if(this.widgets.alfrescoDataTable.lastResultCount==1&&this.widgets.alfrescoDataTable.currentSkipCount>0){var F=this.widgets.alfrescoDataTable;F.currentSkipCount=F.currentSkipCount-F.currentMaxItems}this.widgets.alfrescoDataTable.reloadDataTable()};var z=function x(E,F){this._releaseBusy()};var y=Alfresco.constants.PROXY_URI+"api/comment/node/"+D.nodeRef.replace(":/",""),B=false;if(this.options.siteId){y+=B?"&":"?";y+="site="+encodeURIComponent(this.options.siteId);B=true}if(this.options.activity){y+=B?"&":"?";y+="itemTitle="+encodeURIComponent(this.options.activity.itemTitle)+"&";y+="page="+encodeURIComponent(this.options.activity.page)+"&";y+="pageParams="+encodeURIComponent(YAHOO.lang.JSON.stringify(this.options.activity.pageParams));B=true}Alfresco.util.Ajax.jsonDelete({url:y,successMessage:this.msg("message.delete.success"),successCallback:{fn:C,scope:this},failureMessage:this.msg("message.delete.failure"),failureCallback:{fn:z,scope:this}})},_setBusy:function g(x){if(this.busy){return false}this.busy=true;this.widgets.busyMessage=Alfresco.util.PopupManager.displayMessage({text:x,spanClass:"wait",displayTime:0});return true},_releaseBusy:function h(){if(this.busy){this.widgets.busyMessage.destroy();this.busy=false;return true}else{return false}}})})();