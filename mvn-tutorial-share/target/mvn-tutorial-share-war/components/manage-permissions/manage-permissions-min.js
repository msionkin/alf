(function(){var e=YAHOO.util.Dom;var x=Alfresco.util.encodeHTML,B=Alfresco.util.siteURL;Alfresco.component.ManagePermissions=function(E){Alfresco.component.ManagePermissions.superclass.constructor.call(this,"Alfresco.component.ManagePermissions",E,["button","menu","container","datasource","datatable","paginator","json"]);YAHOO.Bubbling.on("nodeDetailsAvailable",this.onNodeDetailsAvailable,this);YAHOO.Bubbling.on("itemSelected",this.onAuthoritySelected,this);this.deferredReady=new Alfresco.util.Deferred(["onPermissionsLoaded","onNodeDetailsAvailable"],{fn:this.onDeferredReady,scope:this});this.nodeData=null;this.settableRoles=null;this.settableRolesMenuData=null;this.permissions={isInherited:false,inherited:[],current:[]};this.showingAuthorityFinder=false;this.inheritanceWarning=false;return this};YAHOO.extend(Alfresco.component.ManagePermissions,Alfresco.component.Base,{deferredReady:null,nodeData:null,settableRoles:null,settableRolesMenuData:null,permissions:null,sitePermissions:{},showingAuthorityFinder:null,inheritanceWarning:null,options:{nonEditableRoles:["SiteManager"],showGroups:true},onReady:function o(){this.widgets.inherited=Alfresco.util.createYUIButton(this,"inheritedButton",this.onInheritedButton);this.widgets.saveButton=Alfresco.util.createYUIButton(this,"okButton",this.onSaveButton);this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancelButton",this.onCancelButton);this._setupDataSources();this._setupDataTables();Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"components/people-finder/authority-finder",dataObj:{htmlid:this.id+"-authorityFinder"},successCallback:{fn:this.onAuthorityFinderLoaded,scope:this},failureMessage:this.msg("message.authorityFinderFail"),execScripts:true});if(this.options.site){Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"api/sites/"+encodeURIComponent(this.options.site)+"/memberships/",successCallback:{fn:function(F){for(var E=0;E<F.json.length;E++){this.sitePermissions[F.json[E].authority.fullName]=F.json[E].role}},scope:this}})}e.setStyle(this.id+"-body","visibility","visible")},onInheritedButton:function w(G,I){var E=this;if(this.permissions.isInherited&&!this.inheritanceWarning){Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.confirm.inheritance.title"),text:this.msg("message.confirm.inheritance.description"),noEscape:true,buttons:[{text:this.msg("button.yes"),handler:function H(){this.destroy();E.inheritanceWarning=true;E.permissions.isInherited=!E.permissions.isInherited;E._updateInheritedUI()}},{text:this.msg("button.no"),handler:function F(){this.destroy()},isDefault:true}]})}else{this.permissions.isInherited=!this.permissions.isInherited;this._updateInheritedUI()}},_updateInheritedUI:function n(){var E=this.permissions.isInherited;e.removeClass(this.id+"-inheritedButtonContainer","inherited-"+(E?"off":"on"));e.addClass(this.id+"-inheritedButtonContainer","inherited-"+(E?"on":"off"));if(E){e.removeClass(this.id+"-inheritedContainer","hidden")}else{e.addClass(this.id+"-inheritedContainer","hidden")}},onAuthorityFinderLoaded:function v(F){var E=e.get(this.id+"-authorityFinder");if(E){E.innerHTML=F.serverResponse.responseText;this.widgets.authorityFinder=E;this.modules.authorityFinder=Alfresco.util.ComponentManager.get(this.id+"-authorityFinder");this.modules.authorityFinder.setOptions({dataWebScript:Alfresco.constants.URL_SERVICECONTEXT+"components/people-finder/authority-query",viewMode:Alfresco.AuthorityFinder.VIEW_MODE_COMPACT,singleSelectMode:true,minSearchTermLength:3,authorityType:(this.options.showGroups)?Alfresco.AuthorityFinder.AUTHORITY_TYPE_ALL:Alfresco.AuthorityFinder.AUTHORITY_TYPE_USERS});this.widgets.addUserGroup=Alfresco.util.createYUIButton(this,"addUserGroupButton",this.onAddUserGroupButton,{type:"checkbox",checked:false});var G=e.getRegion(this.id+"-addUserGroupButton");e.setStyle(this.widgets.authorityFinder,"top",(G.bottom+4)+"px")}Alfresco.util.Ajax.jsonGet({url:Alfresco.constants.PROXY_URI+"slingshot/doclib/permissions/"+Alfresco.util.NodeRef(this.options.nodeRef).uri,successCallback:{fn:this.onPermissionsLoaded,scope:this},failureMessage:this.msg("message.permissionsGetFail")})},onNodeDetailsAvailable:function l(F,E){this.nodeData=E[1].nodeDetails;this.deferredReady.fulfil("onNodeDetailsAvailable")},onPermissionsLoaded:function a(E){var H=E.json;this.permissions={originalIsInherited:H.isInherited,isInherited:H.isInherited,canReadInherited:H.canReadInherited,inherited:H.inherited,original:Alfresco.util.deepCopy(H.direct),current:Alfresco.util.deepCopy(H.direct)};if(!this.permissions.canReadInherited){this.widgets.dtInherited.set("MSG_EMPTY",this.msg("message.empty.no-permission"))}this.inheritanceWarning=!H.isInherited;this.settableRoles=H.settable;this.settableRolesMenuData=[];for(var F=0,G=H.settable.length;F<G;F++){this.settableRoles[H.settable[F]]=true;this.settableRolesMenuData.push({text:H.settable[F],value:H.settable[F]})}this.deferredReady.fulfil("onPermissionsLoaded")},onDeferredReady:function d(){e.get(this.id+"-title").innerHTML=this.msg("title",this.nodeData.displayName);var F=this;var E=function G(J,I){var H=YAHOO.Bubbling.getOwnerByTagName(I[1].anchor,"div");if(H!==null){if(typeof F[H.className]=="function"){I[1].stop=true;var K=F.widgets.dtDirect.getRecord(I[1].target.offsetParent).getData();F[H.className].call(F,K,H)}}return true};YAHOO.Bubbling.addDefaultAction("action-link",E);this.render()},onAddUserGroupButton:function D(F,E){if(!this.showingAuthorityFinder){this.modules.authorityFinder.clearResults();e.addClass(this.widgets.authorityFinder,"active");e.addClass(this.id+"-inheritedContainer","table-mask");e.addClass(this.id+"-directContainer","table-mask");e.get(this.id+"-authorityFinder-search-text").focus();this.showingAuthorityFinder=true}else{e.removeClass(this.widgets.authorityFinder,"active");e.removeClass(this.id+"-inheritedContainer","table-mask");e.removeClass(this.id+"-directContainer","table-mask");this.showingAuthorityFinder=false}},onAuthoritySelected:function r(G,E){var F=this.sitePermissions[E[1].itemName];if(F==null){F=this.settableRoles[this.settableRoles.length-1]}this.permissions.current.push({authority:{name:E[1].itemName,displayName:E[1].displayName,iconUrl:E[1].iconUrl},role:F,created:true});this.widgets.addUserGroup.set("checked",false);e.removeClass(this.widgets.authorityFinder,"active");e.removeClass(this.id+"-inheritedContainer","table-mask");e.removeClass(this.id+"-directContainer","table-mask");this.showingAuthorityFinder=false;this.render()},fnRenderCellAuthorityIcon:function z(){var F=this;return function E(I,H,K,M){e.setStyle(I,"width",K.width+"px");e.setStyle(I.parentNode,"width",K.width+"px");var J=H.getData("authority"),L=J.name.indexOf("GROUP_")===0,G=Alfresco.constants.URL_RESCONTEXT+"components/images/"+(L?"group":"no-user-photo")+"-64.png";if(J.avatar&&J.avatar.length!==0){G=Alfresco.constants.PROXY_URI+J.avatar+"?c=queue&ph=true"}else{if(J.iconUrl){G=J.iconUrl}}I.innerHTML='<img class="icon32" src="'+G+'" alt="icon" />'}},fnRenderCellText:function g(){var E=this;return function F(H,G,I,J){e.setStyle(H,"width",I.width+"px");e.setStyle(H.parentNode,"width",I.width+"px");H.innerHTML=x(J)}},_i18nRole:function j(E){return this.msg("roles."+E.toLowerCase())},fnRenderCellRoleText:function c(H,G,I,J){var F=this;return function E(L,K,M,N){arguments[3]=F._i18nRole(arguments[3]);F.fnRenderCellText().apply(F,arguments)}},fnRenderCellRole:function u(){var E=this;return function F(P,Q,M,G){e.setStyle(P,"width",M.width+"px");e.setStyle(P.parentNode,"width",M.width+"px");var J=Q.getData("role"),N=Q.getData("index"),O="roles-"+Q.getId(),L=[];if(!E._isRoleEditable(J)||!E.settableRoles.hasOwnProperty(J)){P.innerHTML="<span>"+x(E._i18nRole(Q.getData("role")))+"</span>"}else{L=L.concat(E.settableRolesMenuData);for(var I=0,K=L.length;I<K;I++){L[I].text=E._i18nRole(L[I].value)}P.innerHTML='<span id="'+O+'"></span>';var H=new YAHOO.widget.Button({container:O,type:"menu",menu:L});H.getMenu().subscribe("click",function(S,R){return function T(W,V){var U=R[1];if(U){W.set("label",E._i18nRole(U.value));E.onRoleChanged.call(E,R[1],V)}}(H,N)});H.set("label",x(E._i18nRole(Q.getData("role"))))}}},fnRenderCellActions:function m(){var E=this;return function F(I,H,J,L){var K=H.getData("role");e.setStyle(I,"width",J.width+"px");e.setStyle(I.parentNode,"width",J.width+"px");var G='<div id="'+E.id+"-actions-"+H.getId()+'" class="hidden action-set">';if(E._isRoleEditable(K)){G+='<div class="onActionDelete"><a class="action-link" title="'+E.msg("button.delete")+'"><span>'+E.msg("button.delete")+"</span></a></div>"}G+="</div>";I.innerHTML=G}},render:function i(){this._updateInheritedUI();this.widgets.dsInherited.sendRequest(this.permissions.inherited,{success:this.widgets.dtInherited.onDataReturnInitializeTable,failure:this.widgets.dtInherited.onDataReturnInitializeTable,scope:this.widgets.dtInherited});this.widgets.dsDirect.sendRequest(this.permissions.current,{success:this.widgets.dtDirect.onDataReturnInitializeTable,failure:this.widgets.dtDirect.onDataReturnInitializeTable,scope:this.widgets.dtDirect})},generateData:function h(I){var J=[],H;for(var F=0,G=I.length;F<G;F++){H=I[F];if(!H.removed&&!(H.authority.name==="GROUP_EVERYONE"&&H.role==="ReadPermissions")){J.push({index:F,authority:H.authority,displayName:H.authority.displayName,isGroup:H.authority.name.indexOf("GROUP_")==0,role:H.role})}}function E(L,K){return(!L.isGroup&&K.isGroup)?1:(L.isGroup&&!K.isGroup)?-1:(L.displayName>K.displayName)?1:(L.displayName<K.displayName)?-1:0}return J.sort(E)},_setupDataSources:function p(){this.widgets.dsInherited=new YAHOO.util.DataSource(this.generateData,{responseType:YAHOO.util.DataSource.TYPE_JSFUNCTION,scope:this});this.widgets.dsDirect=new YAHOO.util.DataSource(this.generateData,{responseType:YAHOO.util.DataSource.TYPE_JSFUNCTION,scope:this})},_setupDataTables:function b(){var E=(this.options.showGroups)?this.msg("column.authority"):this.msg("column.user");var F=[{key:"icon",label:"",sortable:false,formatter:this.fnRenderCellAuthorityIcon(),width:32},{key:"displayName",label:E,sortable:false},{key:"role",label:this.msg("column.role"),sortable:false,formatter:this.fnRenderCellRoleText(),width:240}];this.widgets.dtInherited=new YAHOO.widget.DataTable(this.id+"-inheritedPermissions",F,this.widgets.dsInherited,{initialLoad:false,MSG_EMPTY:this.msg("message.empty"),MSG_LOADING:this.msg("message.loading")});F=[{key:"icon",label:"",sortable:false,formatter:this.fnRenderCellAuthorityIcon(),width:32},{key:"displayName",label:E,sortable:false},{key:"role",label:this.msg("column.role"),sortable:false,formatter:this.fnRenderCellRole(),width:240},{key:"actions",label:this.msg("column.actions"),sortable:false,formatter:this.fnRenderCellActions(),width:120}];this.widgets.dtDirect=new YAHOO.widget.DataTable(this.id+"-directPermissions",F,this.widgets.dsDirect,{initialLoad:false,MSG_EMPTY:this.msg("message.empty"),MSG_LOADING:this.msg("message.loading")});this.widgets.dtDirect.subscribe("rowMouseoverEvent",this.onEventHighlightRow,this,true);this.widgets.dtDirect.subscribe("rowMouseoutEvent",this.onEventUnhighlightRow,this,true)},_isRoleEditable:function k(E){return this.permissions.isInherited||!Alfresco.util.arrayContains(this.options.nonEditableRoles,E)},onEventHighlightRow:function t(E){this.widgets.dtDirect.onEventHighlightRow.call(this.widgets.dtDirect,E);e.removeClass(this.id+"-actions-"+E.target.id,"hidden")},onEventUnhighlightRow:function A(E){this.widgets.dtDirect.onEventUnhighlightRow.call(this.widgets.dtDirect,E);e.addClass(this.id+"-actions-"+E.target.id,"hidden")},onRoleChanged:function q(H,G){var F=this.permissions.current[G],E=this.permissions.original;F.role=H.value;F.modified=(G<=E.length&&E[G]!=null&&F.role!==E[G].role)},onActionDelete:function y(F){var E=this.permissions.current[F.index];E.removed=true;this.render()},onSaveButton:function f(J,E){this.widgets.saveButton.set("disabled",true);var I=[],H;for(var F=0,G=this.permissions.current.length;F<G;F++){H=this.permissions.current[F];if((H.created&&!H.removed)||(!H.created&&(H.removed||H.modified))){if(H.modified&&!H.created){I.push({authority:H.authority.name,role:this.permissions.original[F].role,remove:true})}I.push({authority:H.authority.name,role:H.role,remove:H.removed})}}if(I.length>0||this.permissions.isInherited!==this.permissions.originalIsInherited){Alfresco.util.Ajax.jsonPost({url:Alfresco.constants.PROXY_URI+"slingshot/doclib/permissions/"+Alfresco.util.NodeRef(this.options.nodeRef).uri,dataObj:{permissions:I,isInherited:this.permissions.isInherited},successCallback:{fn:function(K){this._navigateForward()},scope:this},failureCallback:{fn:function(K){var L=Alfresco.util.parseJSON(K.serverResponse.responseText);Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.failure"),text:this.msg("message.failure.text",L.message)});this.widgets.saveButton.set("disabled",false)},scope:this}})}else{this._navigateForward()}},onCancelButton:function s(F,E){this.widgets.cancelButton.set("disabled",true);this._navigateForward()},_navigateForward:function C(){window.history.go(-1)}})})();