(function(){var f=YAHOO.util.Dom,j=YAHOO.util.Event;var d=Alfresco.util.encodeHTML,c=function c(m,n){return Alfresco.util.formatDate(Alfresco.util.fromISO8601(m),n)};Alfresco.ConsoleTagManagement=function e(m){Alfresco.ConsoleTagManagement.superclass.constructor.call(this,"Alfresco.ConsoleTagManagement",m,["button","container","datasource","datatable","paginator","history","animation"]);return this};YAHOO.extend(Alfresco.ConsoleTagManagement,Alfresco.component.Base,{options:{pageSize:15},searchTerm:"",resultsCount:0,currentPage:1,onReady:function k(){this._setupDataTable();this.widgets.searchButton=Alfresco.util.createYUIButton(this,"search-button",this.onSearchClick);var m=f.get(this.id+"-search-text");this.widgets.enterListener=new YAHOO.util.KeyListener(m,{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:this.onSearchClick,scope:this,correctScope:true},"keydown").enable();m.value=this.searchTerm;this._performSearch({searchTerm:this.searchTerm})},_setupDataTable:function h(){var w=this;var n=function s(A,z,C,E){var y=z.getData().name;var D;if(y.length>30){D=d(y.substring(0,30)+"...")}else{D=d(y)}var B='<span><a class="theme-color-1" title="'+d(y)+'" href="'+Alfresco.constants.URL_PAGECONTEXT+"repository#filter=tag|"+encodeURIComponent(y)+'&page=1"><b>'+D+"</b></a></span>";A.innerHTML=B};var x=function v(A,z,C,D){var y=z.getData().modifier;var B='<span><a class="theme-color-1" href="'+Alfresco.constants.URL_PAGECONTEXT+"user/"+encodeURIComponent(y)+'/profile">'+d(y)+"</a></span>";A.innerHTML=B};var q=function r(A,z,C,D){var y=z.getData().modified;var B="<span>"+c(y,w.msg("date-format.default"))+"</span>";A.innerHTML=B};var o=function u(D,E,C,y){var G=E.getData();var A="",z,F,B=E._nCount;A+='<a id="'+w.id+"-edit-link-"+B+'" href="#" class="edit-tag" title="'+w.msg("title.editTag")+'">&nbsp;</a>';A+='<a id="'+w.id+"-delete-link-"+B+'" href="#" class="delete-tag" title="'+w.msg("title.deleteTag")+'">&nbsp;</a>';D.innerHTML=A;F=f.getChildrenBy(D,function(H){return H.id===w.id+"-delete-link-"+B})[0];z=f.getChildrenBy(D,function(H){return H.id===w.id+"-edit-link-"+B})[0];j.addListener(E.getId(),"mouseover",function(){f.addClass(F,"delete-tag-active");f.addClass(z,"edit-tag-active")});j.addListener(E.getId(),"mouseout",function(){f.removeClass(F,"delete-tag-active");f.removeClass(z,"edit-tag-active")});j.addListener(F,"click",function(){w.onActionDelete(G.name)},F,false);j.addListener(z,"click",function(){w.onActionEdit(G.name)},z,false)};var m=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/tags/{store_type}/{store_id}?details=true",{store_type:"workspace",store_id:"SpacesStore"});this.widgets.dataSource=new YAHOO.util.DataSource(m);this.widgets.dataSource.responseType=YAHOO.util.DataSource.TYPE_JSON;this.widgets.dataSource.connXhrMode="queueRequests";this.widgets.dataSource.responseSchema={resultsList:"data.items",fields:["name","modifier","modified"]};this.widgets.paginator=new YAHOO.widget.Paginator({containers:this.id+"-paginator",rowsPerPage:this.options.pageSize,initialPage:1,template:this.msg("pagination.template"),pageReportTemplate:this.msg("pagination.template.page-report"),previousPageLinkLabel:this.msg("pagination.previousPageLinkLabel"),nextPageLinkLabel:this.msg("pagination.nextPageLinkLabel")});var t=[{key:"name",label:w.msg("title.tagName"),sortable:false,formatter:n,width:120},{key:"modifiedBy",label:w.msg("title.modifiedBy"),sortable:false,formatter:x,width:150},{key:"modifiedOn",label:w.msg("title.modifiedOn"),sortable:false,formatter:q,width:150},{key:"action",label:w.msg("title.actions"),sortable:false,formatter:o,width:45}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-tags",t,this.widgets.dataSource,{renderLoopSize:Alfresco.util.RENDERLOOPSIZE,initialLoad:false,paginator:this.widgets.paginator,MSG_LOADING:this.msg("loading-tags"),MSG_EMPTY:this.msg("no-tag-found")});this.widgets.dataTable.doBeforeLoadData=function p(z,A,C){if(A.error){try{var y=YAHOO.lang.JSON.parse(A.responseText);w.widgets.dataTable.set("MSG_ERROR",y.message)}catch(B){w._setDefaultDataTableErrors(w.widgets.dataTable)}}else{if(A.results){w.widgets.dataTable.set("MSG_EMPTY","");w.hasMoreResults=(A.results.length>w.options.maxSearchResults);if(w.hasMoreResults){A.results=A.results.slice(0,w.options.maxSearchResults)}w.resultsCount=A.results.length;if(w.resultsCount>0){f.removeClass(w.id+"-paginator","hidden");f.removeClass(w.id+"-tags-list-bar-bottom","hidden");f.removeClass(w.id+"-tags","hidden");f.addClass(w.id+"-tags-list-info","hidden")}else{f.addClass(w.id+"-paginator","hidden");f.addClass(w.id+"-tags-list-bar-bottom","hidden");f.addClass(w.id+"-tags","hidden");f.get(w.id+"-tags-list-info").innerHTML=w.msg("no-tag-found");f.removeClass(w.id+"-tags-list-info","hidden")}}}return true};this.widgets.paginator.subscribe("changeRequest",function(z,y){y.currentPage=z.page;y.widgets.paginator.setState(z)},this);this.widgets.dataTable.subscribe("renderEvent",function(){w.widgets.paginator.setState({page:w.currentPage,totalRecords:w.resultsCount});w.widgets.paginator.render()})},onSearchClick:function a(o,n){var m=f.get(this.id+"-search-text");this._performSearch({searchTerm:m.value})},_performSearch:function l(n){if(n.searchTerm!=undefined){this.searchTerm=YAHOO.lang.trim(n.searchTerm)}this.widgets.dataTable.deleteRows(0,this.widgets.dataTable.getRecordSet().getLength());this.widgets.dataTable.set("MSG_EMPTY","");this.widgets.dataTable.render();function m(p,q,r){this.widgets.dataTable.onDataReturnInitializeTable.call(this.widgets.dataTable,p,q,r);this.resultsCount=q.results.length;f.get(this.id+"-search-text").focus()}function o(q,r){if(r.status==401){window.location.reload()}else{try{var p=YAHOO.lang.JSON.parse(r.responseText);this.widgets.dataTable.set("MSG_ERROR",p.message);this.widgets.dataTable.showTableMessage(p.message,YAHOO.widget.DataTable.CLASS_ERROR)}catch(s){this._setDefaultDataTableErrors(this.widgets.dataTable);this.widgets.dataTable.render()}}}if(this.searchTerm==""||this.searchTerm=="*"){this.widgets.dataSource.sendRequest("",{success:m,failure:o,scope:this})}else{this.widgets.dataSource.sendRequest("&tf="+encodeURIComponent(this.searchTerm),{success:m,failure:o,scope:this})}},onActionEdit:function i(p){var r=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/tags/{store_type}/{store_id}/{tagName}?alf_method=PUT",{store_type:"workspace",store_id:"SpacesStore",tagName:encodeURIComponent(p)});var n=function m(t){t.addValidation(this.id+"-edit-tag-name",Alfresco.forms.validation.mandatory,null,"keyup")};var o=new Alfresco.module.SimpleDialog(this.id+"-edit-tag");o.setOptions({width:"30em",templateUrl:YAHOO.lang.substitute(Alfresco.constants.URL_PAGECONTEXT+"components/admin/edit-tag?htmlid={id}&tagName={tagName}",{id:this.id+"-edit-tag",tagName:encodeURIComponent(p)}),actionUrl:r,destroyOnHide:true,doSetupFormsValidation:{fn:n,scope:this},onSuccess:{fn:function q(t){if(t.json.result==true){Alfresco.util.PopupManager.displayMessage({text:this.msg(t.json.msg)});this._performSearch({searchTerm:this.searchTerm})}else{Alfresco.util.PopupManager.displayPrompt({title:this.msg("title.error"),text:this.msg(t.json.msg),buttons:[{text:this.msg("button.close"),handler:function u(){this.destroy()}}]})}},scope:this},onFailure:{fn:function s(t){if(t.serverResponse.status===400&&t.json!=undefined&&t.json.result===false){Alfresco.util.PopupManager.displayMessage({text:this.msg(t.json.msg)})}else{Alfresco.util.PopupManager.displayMessage({text:this.msg("message.edit.failure")})}},scope:this}}).show()},onActionDelete:function g(o){var p=this;Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.confirm.delete.title"),text:this.msg("message.confirm.delete",o),buttons:[{text:this.msg("button.delete"),handler:function n(){this.destroy();p._onActionDeleteConfirm(o)}},{text:this.msg("button.cancel"),handler:function m(){this.destroy()},isDefault:true}]})},_onActionDeleteConfirm:function b(m){Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.DELETE,url:YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/tags/{store_type}/{store_id}/{tagName}",{store_type:"workspace",store_id:"SpacesStore",tagName:encodeURIComponent(m)}),successCallback:{fn:function n(o){Alfresco.util.PopupManager.displayMessage({text:this.msg(o.json.msg)});if(o.json.result==true){this._performSearch({searchTerm:this.searchTerm})}},scope:this},failureMessage:this.msg("message.delete.failure")})}})})();