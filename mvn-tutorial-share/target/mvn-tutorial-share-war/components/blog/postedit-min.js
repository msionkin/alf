(function(){var g=YAHOO.util.Dom;Alfresco.BlogPostEdit=function(n){Alfresco.BlogPostEdit.superclass.constructor.call(this,"Alfresco.BlogPostEdit",n,["button","menu","json"]);this.blogPostData=null;this.performExternalPublish=false;return this};YAHOO.extend(Alfresco.BlogPostEdit,Alfresco.component.Base,{options:{siteId:"",containerId:"blog",editMode:false,postId:""},blogPostData:null,performExternalPublish:null,showNotConfiguredMessage:false,onReady:function d(){if(this.options.editMode){this._loadBlogPostData()}else{this._initializeBlogPostForm()}},_loadBlogPostData:function a(){var p=this;var n=function q(r){var s=r.json.item;p.blogPostData=s;p._initializeBlogPostForm()};var o=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/blog/post/site/{site}/{container}/{postId}",{site:this.options.siteId,container:this.options.containerId,postId:this.options.postId});Alfresco.util.Ajax.request({url:o,method:"GET",responseContentType:"application/json",successCallback:{fn:n,scope:this},failureMessage:this.msg("message.loadpostdata.failure")})},_initializeBlogPostForm:function c(){var p,n=true,q="",o="";if(this.options.editMode){p=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/blog/post/node/{nodeRef}",{nodeRef:this.blogPostData.nodeRef.replace(":/","")})}else{p=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/blog/site/{site}/{container}/posts",{site:this.options.siteId,container:this.options.containerId})}g.get(this.id+"-form").setAttribute("action",p);g.get(this.id+"-site").setAttribute("value",this.options.siteId);g.get(this.id+"-container").setAttribute("value",this.options.containerId);if(this.options.editMode){n=this.blogPostData.isDraft}g.get(this.id+"-draft").setAttribute("value",n);if(this.options.editMode){q=this.blogPostData.title}g.get(this.id+"-title").setAttribute("value",q);if(this.options.editMode){o=this.blogPostData.content}g.get(this.id+"-content").value=o;this._registerBlogPostForm()},_registerBlogPostForm:function k(){this.modules.tagLibrary=new Alfresco.module.TagLibrary(this.id);this.modules.tagLibrary.setOptions({siteId:this.options.siteId});if(this.options.editMode&&this.blogPostData.tags.length>0){this.modules.tagLibrary.setTags(this.blogPostData.tags)}this.widgets.saveButton=new YAHOO.widget.Button(this.id+"-save-button",{type:"submit",label:this.msg(this.options.editMode?"action.update":"action.saveAsDraft")});if(!this.options.editMode||this.blogPostData.isDraft){this.widgets.publishButton=Alfresco.util.createYUIButton(this,"publish-button",this.onFormPublishButtonClick);g.removeClass(this.id+"-publish-button","hidden")}var n="";if(!this.options.editMode){n=this.msg("action.publishIntAndExt")}else{if(this.blogPostData.isPublished){n=this.msg("action.updateIntAndExt")}else{n=this.msg("action.updateIntAndPublishExt")}}this.widgets.publishExternalButton=Alfresco.util.createYUIButton(this,"publishexternal-button",this.onFormPublishExternalButtonClick,{label:n});this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel-button",this.onFormCancelButtonClick);this.widgets.editor=new Alfresco.util.RichEditor(Alfresco.constants.HTML_EDITOR,this.id+"-content",this.options.editorConfig);this.widgets.editor.addPageUnloadBehaviour(this.msg("message.unsavedChanges.blog"));this.widgets.editor.render();this.widgets.postForm=new Alfresco.forms.Form(this.id+"-form");this.widgets.postForm.addValidation(this.id+"-title",Alfresco.forms.validation.mandatory,null,"blur");this.widgets.postForm.addValidation(this.id+"-title",Alfresco.forms.validation.length,{max:256,crop:true},"keyup");if(this.widgets.publishButton){this.widgets.postForm.setSubmitElements([this.widgets.saveButton,this.widgets.publishExternalButton,this.widgets.publishButton])}else{this.widgets.postForm.setSubmitElements([this.widgets.saveButton,this.widgets.publishExternalButton])}this.widgets.postForm.setAJAXSubmit(true,{successCallback:{fn:this.onFormSubmitSuccess,scope:this},failureMessage:this.msg("message.savepost.failure"),failureCallback:{fn:this.onFormSubmitFailure,scope:this}});if(this.options.editMode){this.widgets.postForm.setAjaxSubmitMethod(Alfresco.util.Ajax.PUT)}this.widgets.postForm.setSubmitAsJSON(true);this.widgets.postForm.doBeforeFormSubmit={fn:function(o,p){this.widgets.editor.save();this.widgets.cancelButton.set("disabled",true);this.modules.tagLibrary.updateForm(this.id+"-form","tags");this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message(this.msg("message.submitting")),spanClass:"wait",displayTime:0})},scope:this};this.modules.tagLibrary.initialize(this.widgets.postForm);this.widgets.postForm.init();g.removeClass(this.id+"-div","hidden");g.get(this.id+"-title").focus()},onFormPublishButtonClick:function e(o,n){g.get(this.id+"-draft").setAttribute("value",false);this.widgets.saveButton.fireEvent("click",{type:"click"})},onFormPublishExternalButtonClick:function m(o,n){g.get(this.id+"-draft").setAttribute("value",false);this.performExternalPublish=true;this.widgets.saveButton.fireEvent("click",{type:"click"})},onFormCancelButtonClick:function b(o,n){history.go(-1)},onFormSubmitSuccess:function j(o){this.widgets.feedbackMessage.destroy();if(this.performExternalPublish){this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message(this.msg("message.postSavedNowPublish")),spanClass:"wait",displayTime:0});this.showNotConfiguredMessage=!o.json.metadata.externalBlogConfig;var n=o.json.item.name;if(o.json.item.isPublished){this.onUpdateExternal(n)}else{this.onPublishExternal(n)}}else{Alfresco.util.PopupManager.displayMessage({text:this.msg("message.savepost.success")});this._loadPostViewPage(o.json.item.name)}},onFormSubmitFailure:function l(){this.widgets.cancelButton.set("disabled",false);this.widgets.feedbackMessage.destroy()},onPublishExternal:function f(n){var r=function o(u){this._loadPostViewPage(n)};var s=function t(u){this.widgets.feedbackMessage.destroy();var v=this;Alfresco.util.PopupManager.displayPrompt({text:this.msg("message.publishExternal.failure"),buttons:[{text:this.msg("button.ok"),handler:function(){v._loadPostViewPage(n)},isDefault:true}]})};var p=Alfresco.util.blog.generatePublishingRestURL(this.options.siteId,this.options.containerId,n);var q=this.msg("message.savepost.success");if(this.showNotConfiguredMessage){q=this.msg("message.publishExternal.failure")}Alfresco.util.Ajax.request({url:p,method:"POST",requestContentType:"application/json",responseContentType:"application/json",dataObj:{action:"publish"},successMessage:q,successCallback:{fn:r,scope:this},failureCallback:{fn:s,scope:this}})},onUpdateExternal:function i(n){var p=function s(t){this._loadPostViewPage(n)};var r=function q(t){this.widgets.feedbackMessage.destroy();var u=this;Alfresco.util.PopupManager.displayPrompt({text:this.msg("message.updateExternal.failure"),buttons:[{text:this.msg("button.ok"),handler:function(){u._loadPostViewPage(n)},isDefault:true}]})};var o=Alfresco.util.blog.generatePublishingRestURL(this.options.siteId,this.options.containerId,n);Alfresco.util.Ajax.request({url:o,method:"POST",requestContentType:"application/json",responseContentType:"application/json",dataObj:{action:"update"},successMessage:this.msg("message.updateExternal.success"),successCallback:{fn:p,scope:this},failureCallback:{fn:r,scope:this}})},_loadPostViewPage:function h(n){window.location=Alfresco.util.blog.generateBlogPostViewUrl(this.options.siteId,this.options.containerId,n)}})})();