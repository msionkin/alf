define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_FocusMixin","dojo/text!./templates/UserStatus.html","alfresco/core/Core","dijit/form/Textarea","dojo/on","dojo/_base/event","dojo/request/xhr","dojo/keys","dijit/focus","dojo/_base/array","dijit/registry","dojo/dom-style"],function(w,b,q,f,x,i,l,g,u,e,j,s,c,d,o){return w([b,q,f,i],{i18nScope:"org.alfresco.UserStatus",cssRequirements:[{cssFile:"./css/UserStatus.css"}],i18nRequirements:[{i18nFile:"./i18n/UserStatus.properties"}],templateString:x,_userStatusWidget:null,unknownStatus:null,userStatus:"",userStatusTime:null,_popupLocks:null,focus:function r(){this.alfLog("log","User Status focus");if(this._userStatusWidget){this._userStatusWidget.focus()}},_onFocus:function m(){var y=this;this.alfLog("log","UserStatus Focus - LOCK");this._popupLocks=[];c.forEach(s.activeStack,function(A,z){var B=d.byId(A);if(typeof B.lockPopupsOpen=="function"){y.alfLog("log","Locking popups of ",B);B.lockPopupsOpen(true);y._popupLocks.push(B)}});this.inherited(arguments)},_onBlur:function n(){var y=this;this.alfLog("log","UserStatus Blur - UNLOCK");c.forEach(this._popupLocks,function(A,z){if(typeof A.lockPopupsOpen=="function"){y.alfLog("log","Unlocking popups of ",A);A.lockPopupsOpen(false)}});this.inherited(arguments)},postCreate:function h(){var z=this;this.alfSubscribe("ALF_USER_STATUS_UPDATED",function(A){z.statusUpdated(A)});this.unknownStatus=(this.userStatus=="");if(this.unknownStatus){this.userStatus=this.message("unknown.status.label")}this._userStatusWidget=new l({value:this.userStatus});this._userStatusWidget.placeAt(this.focusNode);var y=3;if(this.userStatus!=null){y=Math.ceil(this.userStatus.length/30)}o.set(this._userStatusWidget.domNode,"height",(y*25)+"px");this.setStatusRelativeTime();this._postButtonNode.innerHTML=this.message("post.button.label");g(this._postButtonNode,"click",function(A){z.postStatus(A)});this._userStatusWidget.on("click",function(A){z.onUserStatusClick(A)});this._userStatusWidget.on("blur",function(A){z.onUserStatusBlur(A)});g(this._userStatusWidget.textbox,"keydown",function(B){z.alfLog("log","User Status KeyDown");var A=function(){};if(B.keyCode==j.SPACE){B.preventDefault=A}});g(this._userStatusWidget.textbox,"keyup",function(A){z.alfLog("log","User Status Keyup");if(A.keyCode==j.ENTER){z.postStatus(A);u.stop(A)}else{if(A.keyCode==j.SPACE){u.stop(A)}}})},setStatusRelativeTime:function v(){var y=(this.unknownStatus)?this.message("status.never-updated"):this.getRelativeTime(this.userStatusTime);this._lastUpdateNode.innerHTML=this.message("status.updated",[y])},postStatus:function t(y){this.alfPublish("ALF_UPDATE_USER_STATUS",{status:this._userStatusWidget.get("value")})},statusUpdated:function p(y){this._userStatusClickedOnce=false;if(y.userStatus){this._userStatusWidget.set("value",y.userStatus);this.userStatus=y.userStatus;this.unknownStatus=false}else{this.userStatus=this._userStatusWidget.get("value")}if(y.userStatusTime){this.userStatusTime=y.userStatusTime;this.setStatusRelativeTime()}this.displayMessage(this.message("message.status.success"))},_userStatusClickedOnce:false,onUserStatusClick:function k(y){if(this._userStatusClickedOnce){}else{this._userStatusWidget.set("value","");this._userStatusClickedOnce=true}},onUserStatusBlur:function a(y){this.alfLog("log","User Status Blur");if(this._userStatusWidget.get("value").length==0){this._userStatusWidget.set("value",this.userStatus);this._userStatusClickedOnce=false}else{}}})});