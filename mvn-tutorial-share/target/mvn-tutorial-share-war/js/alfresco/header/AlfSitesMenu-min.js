define(["dojo/_base/declare","alfresco/header/AlfMenuBarPopup","alfresco/core/CoreXhr","dojo/_base/lang","dojo/_base/array","dojo/aspect","dijit/registry","alfresco/menus/AlfMenuGroup","alfresco/header/AlfMenuItem","alfresco/header/AlfCascadingMenu","dojo/dom-style","dijit/popup"],function(C,f,v,G,j,n,k,g,A,E,o,b){return C([f,v],{i18nRequirements:[{i18nFile:"./i18n/AlfSitesMenu.properties"}],currentUser:null,currentSite:null,constructor:function e(){this.alfSubscribe("ALF_FAVOURITE_SITE_ADDED",G.hitch(this,"favouriteAdded"));this.alfSubscribe("ALF_FAVOURITE_SITE_REMOVED",G.hitch(this,"favouriteRemoved"));this.alfSubscribe("ALF_SITE_DETAILS_UPDATED",G.hitch(this,"siteDetailsUpdated"));this.alfSubscribe("ALF_SITE_JOINED",G.hitch(this,"siteJoined"));this.alfSubscribe("ALF_SITE_LEFT",G.hitch(this,"siteLeft"))},showRecentSites:true,showUsefulGroup:true,showSiteFinder:true,showCreateSite:true,showFavourites:true,widgets:[{name:"alfresco/header/AlfMenuItem",config:{iconClass:"alf-loading-icon",label:"loading.label"}}],postCreate:function z(){if(!this.label){this.set("label",this.message("menu.label"))}this.inherited(arguments);if(this.popup){this.popup.onOpen=dojo.hitch(this,"loadMenu")}else{this.alfLog("log","No Sites Menu popup - something has gone wrong!")}},_menuUrl:null,_menuLoaded:false,loadMenu:function q(){if(this._menuLoaded){this.alfLog("log","Menu already loaded")}else{this.alfLog("log","Loading menu");var H=this._menuUrl;if(H==null){H=Alfresco.constants.URL_SERVICECONTEXT+"header/sites-menu/recent";if(this.currentSite){H=H+"/site/"+this.currentSite}}this.serviceXhr({url:H,method:"GET",successCallback:this._menuDataLoaded,failureCallback:this._menuDataLoadFailed,callbackScope:this})}},_menuDataLoaded:function i(I,H){this.alfLog("log","Menu data loaded successfully",I);this._menuLoaded=true;var J=(this.popup&&this.popup.getChildren().length>0&&this.popup.getChildren()[0].focused);var K=this;j.forEach(this.popup.getChildren(),function(M,L){K.popup.removeChild(M)});if(I.widgetsRecent&&I.widgetsRecent.length>0){this.addRecentGroup(I.widgetsRecent)}this.addUsefulGroup(I.showAddFavourite,I.showRemoveFavourite);if(J){if(this.recentGroup){this.recentGroup.focusFirstChild()}else{this.usefulGroup.focusFirstChild()}}this.favoritesCascade.popup.onOpen=dojo.hitch(this,"loadFavourites")},addRecentGroup:function p(H){if(this.popup&&this.showRecentSites){this.recentGroup=new g({label:this.recentGroupLabel});j.forEach(H,dojo.hitch(this,"_addMenuItem",this.recentGroup));this.popup.addChild(this.recentGroup)}},_menuDataLoadFailed:function s(I,H){this.alfLog("error","Could not load sites menu items",I);var J=this;j.forEach(this.popup.getChildren(),function(L,K){J.popup.removeChild(L)});this.addMenuFailMessageItem()},_menuMessageItem:null,addMenuFailMessageItem:function m(){this._menuMessageItem=new A({label:"menu.load.error"});this.popup.addChild(this._menuMessageItem)},_favouritesUrl:null,_favouritesLoaded:false,loadFavourites:function t(){if(this._favouritesLoaded){this.alfLog("log","Favourites already loaded")}else{this.alfLog("log","Loading favourites");var H=this._favouritesUrl;if(H==null){H=Alfresco.constants.URL_SERVICECONTEXT+"header/sites-menu/favourites"}this.serviceXhr({url:H,method:"GET",successCallback:this._favouritesDataLoaded,failureCallback:this._favouritesDataLoadFailed,callbackScope:this})}},_favouritesDataLoaded:function x(I,H){this.alfLog("log","Menu data loaded successfully",I);this._favouritesLoaded=true;var J=(this.favouritesList&&this.favouritesList.getChildren().length>0&&this.favouritesList.getChildren()[0].focused);var K=this;j.forEach(this.favouritesList.getChildren(),function(M,L){K.favouritesList.removeChild(M)});if(I.widgetsFavourites){if(I.widgetsFavourites.length>0){I.widgetsFavourites.sort(this.sortFavourites);j.forEach(I.widgetsFavourites,dojo.hitch(this,"_addMenuItem",this.favouritesList))}else{this.addNoFavouritesMessageItem()}}if(J){this.favouritesList.focusFirstChild()}},sortFavourites:function a(I,H){if(I.config&&I.config.label&&H.config&&H.config.label){return(I.config.label>H.config.label)?1:(I.config.label<H.config.label)?-1:0}else{if(I.config&&I.config.label){return 1}else{if(H.config&&H.config.label){return -1}else{return 0}}}},_favouritesDataLoadFailed:function h(I,H){this.alfLog("error","Could not load favourites menu items",I);var J=this;j.forEach(this.favouritesList.getChildren(),function(L,K){J.favouritesList.removeChild(L)});this.addFavouritesFailMessageItem()},_favouritesMessageItem:null,addNoFavouritesMessageItem:function c(){this._favouritesMessageItem=new A({label:"no.favourites.label"});this.favouritesList.addChild(this._favouritesMessageItem)},addFavouritesFailMessageItem:function r(){this._favouritesMessageItem=new A({label:"favourites.load.error"});this.favouritesList.addChild(this._favouritesMessageItem)},_addMenuItem:function(K,J,H){this.alfLog("log","Adding menu item",J,H,K);var I=new A(J.config);K.addChild(I)},addUsefulGroup:function F(I,H){this.alfLog("log","Creating 'Useful' group");if(this.popup&&this.showUsefulGroup){this.usefulGroup=new g({label:this.usefulGroupLabel});if(this.showSiteFinder){this.siteFinder=new A({id:this.id+"_SITE_FINDER",label:this.siteFinderLabel,iconClass:this.siteFinderIconClass,targetUrl:"site-finder"});this.usefulGroup.addChild(this.siteFinder)}if(this.showCreateSite){this.createSite=new A({id:this.id+"_CREATE_SITE",label:this.createSiteLabel,iconClass:this.createSiteIconClass,publishTopic:"ALF_CREATE_SITE"});this.usefulGroup.addChild(this.createSite)}if(this.showFavourites){this.favouritesList=new g({widgets:[{name:"alfresco/header/AlfMenuItem",config:{iconClass:"alf-loading-icon",label:this.message("loading.label")}}]});this.favoritesCascade=new E({id:this.id+"_FAVOURITES",label:this.favouriteGroupLabel,iconClass:this.favouriteGroupIconClass});this.favoritesCascade.popup.addChild(this.favouritesList);this.usefulGroup.addChild(this.favoritesCascade);if(this.currentSite&&this.currentSite!=""&&this.currentUser&&this.currentUser!=""){this.addFavourite=new A({id:this.id+"_ADD_FAVOURITE",label:this.addFavouriteLabel,iconClass:this.addFavouriteIconClass,publishTopic:"ALF_ADD_FAVOURITE_SITE",publishPayload:{site:this.currentSite,user:this.currentUser}});this.removeFavourite=new A({id:this.id+"_REMOVE_FAVOURITE",label:this.removeFavouriteLabel,iconClass:this.removeFavouriteIconClass,publishTopic:"ALF_REMOVE_FAVOURITE_SITE",publishPayload:{site:this.currentSite,user:this.currentUser}});if(I){this.usefulGroup.addChild(this.addFavourite)}if(H){this.usefulGroup.addChild(this.removeFavourite)}}}this.popup.addChild(this.usefulGroup)}},addFavouriteMenuItem:function l(I){this.alfLog("log","Adding favourite menu item",I);if(I&&I.site){if(I.title){this.alfLog("log","Title provided");this._addFavouriteMenuItem(I.site,I.title)}else{this.alfLog("log","No title provided - retrieving from repository...");var J=this,H=this.generateUuid();this.alfSubscribe(H,function(K){if(K&&K.title&&K.shortName){J.alfLog("log","Retrieved site details",K);J._addFavouriteMenuItem(K.shortName,K.title)}else{J.alfLog("error","Site data not returned in the expected structure",K)}});this.alfPublish("ALF_GET_SITE_DETAILS",{site:I.site,responseTopic:H})}}else{this.alfLog("error","A request was made to add a favourite site, but there is no 'site' attribute has been defined.",I)}},_addFavouriteMenuItem:function y(H,J){this.alfLog("log","Adding favourite",H,J);if(this._favouritesMessageItem){this.favouritesList.removeChild(this._favouritesMessageItem)}var K=new A({label:J,iconClass:this.favouriteGroupIconClass,targetUrl:"site/"+H+"/dashboard",siteShortName:H});if(this.favouritesList){var M=this.favouritesList.getChildren(),L=null;for(var I=0;I<M.length&&L==null;I++){if(K.label<M[I].label){L=I}}this.alfLog("log","Adding favourite at index: ",L);this.favouritesList.addChild(K,L)}},favouriteAdded:function u(H){this.alfLog("log","Favourite Site Added",H);if(H.site){if(H.site==this.currentSite){this.usefulGroup.removeChild(this.addFavourite);this.usefulGroup.addChild(this.removeFavourite)}this.addFavouriteMenuItem({site:H.site,title:H.title})}else{this.alfLog("warn","A favourite site has been added, but the site name has NOT been provided. The Sites Menu will not be modified")}},favouriteRemoved:function d(H){this.alfLog("log","Favourite Site Removed",H);if(H&&H.site==this.currentSite){this.usefulGroup.removeChild(this.removeFavourite);this.usefulGroup.addChild(this.addFavourite)}if(this.favouritesList){var I=this;j.forEach(this.favouritesList.getChildren(),function(K,J){if(K.siteShortName==H.site){I.favouritesList.removeChild(K)}})}if(this.favouritesList&&this.favouritesList.getChildren().length==0){this.addNoFavouritesMessageItem()}},siteJoined:function B(H){},siteLeft:function w(H){},siteDetailsUpdated:function D(H){this.alfLog("log","Not yet implemented!")},recentGroupLabel:"recent.sites.label",favouriteGroupLabel:"favourite.sites.label",usefulGroupLabel:"useful.sites.label",favouriteGroupIconClass:"alf-favourite-site-icon",siteFinderLabel:"site-finder.label",siteFinderIconClass:"alf-site-finder-icon",createSiteLabel:"create-site.label",createSiteIconClass:"alf-create-site-icon",addFavouriteLabel:"add-favourite-site.label",addFavouriteIconClass:"alf-add-favourite-site-icon",removeFavouriteLabel:"remove-favourite-site.label",removeFavouriteIconClass:"alf-remove-favourite-site-icon"})});