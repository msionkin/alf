define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","alfresco/services/_PreferenceServiceTopicMixin","dojo/text!./templates/AlfSideBarContainer.html","alfresco/core/Core","dijit/layout/BorderContainer","dojo/_base/lang","dojo/_base/array","dojo/dom-style","dojo/dom-class","dojo/on","dojo/dom-geometry","dojo/window"],function(u,c,r,f,v,n,q,x,j,p,l,m,s,h){return u([c,r,f,n],{cssRequirements:[{cssFile:"./css/AlfSideBarContainer.css"}],templateString:v,showSidebar:true,minSidebarWidth:150,initialSidebarWidth:150,lastSidebarWidth:null,resizer:null,resizeHandlerNode:null,footerHeight:0,customResizeTopics:null,sidebarWidthPreferenceId:"org.alfresco.share.sideBarWidth",postMixInProperties:function g(){this.alfPublish(this.getPreferenceTopic,{preference:this.sidebarWidthPreferenceId,callback:this.setSideBarWidth,callbackScope:this})},setSideBarWidth:function k(y){if(y!=null){this.initialSidebarWidth=y}},postCreate:function b(){if(this.widgets){j.forEach(this.widgets,x.hitch(this,"addWidget"))}var A=parseInt(p.get(this.domNode,"width"),10);var y=(A-this.minSidebarWidth);this.resizer=new YAHOO.util.Resize(this.sidebarNode,{handles:["r"],minWidth:this.minSidebarWidth,maxWidth:y});var z=dojo.query(".yui-resize-handle-inner-r",this.domNode);if(z!=null&z.length==1){this.resizeHandlerNode=z[0];m(this.resizeHandlerNode,"click",x.hitch(this,"onResizeHandlerClick"))}else{this.alfLog("warn","An expected number of resize handles were found",z)}this.alfSubscribe("ALF_DOCLIST_SHOW_SIDEBAR",x.hitch(this,"showEventListener"));if(this.customResizeTopics!=null&&this.customResizeTopics.length){var B=this;j.forEach(this.customResizeTopics,function(C,D){B.alfSubscribe(C,x.hitch(B,"resizeHandler"))})}this.resizer.on("resize",x.hitch(this,"resizeHandler"));this.resizer.on("endResize",x.hitch(this,"endResizing"));m(window,"resize",x.hitch(this,"resizeHandler"));this.lastSidebarWidth=this.initialSidebarWidth;this.resizeHandler({width:this.lastSidebarWidth});this.render(this.showSidebar)},addWidget:function o(A,y){var z=null;if(A.align=="sidebar"){z=this.createWidgetDomNode(A,this.sidebarNode)}else{z=this.createWidgetDomNode(A,this.mainNode)}this.createWidget(A,z)},resizeHandler:function t(F){var H=parseInt(p.get(this.domNode,"width"),10);var E=this.lastSidebarWidth;if(F&&F.width!=null){E=F.width;this.lastSidebarWidth=E}var C=s.getMarginBox(this.containerNode);var y=h.getBox();var z=y.h-C.t-this.footerHeight;var G=this.calculateHeight(this.sidebarNode,0,this.sidebarNode.children.length-1);var A=this.calculateHeight(this.mainNode,0,this.mainNode.children.length);this.alfLog("log","Sidebar height: "+G+"px");this.alfLog("log","Main content height: "+A+"px");this.alfLog("log","Viewport height: "+z+"px");var D=(G>A)?G:A;var B=(D>z)?D:z;this.alfLog("log","Setting height as (px): ",B);p.set(this.sidebarNode,"height",B+"px");p.set(this.mainNode,"width",(H-E)+"px");this.alfPublish("ALF_NODE_RESIZED",{node:this.mainNode})},endResizing:function w(y){this.resizeHandler(y);this.alfPublish(this.setPreferenceTopic,{preference:this.sidebarWidthPreferenceId,value:y.width});this.hiddenSidebarWidth=y.width},calculateHeight:function i(B,C,y){var A=0;for(var z=C;z<y;z++){A=A+parseInt(p.get(B.children[z],"height"),10)}return A},showEventListener:function e(y){this.alfLog("log","Handle show request",y);if(y&&y.selected!=null){this.render(y.selected)}},onResizeHandlerClick:function d(y){if(this.resizeHandlerNode){this.alfPublish("ALF_DOCLIST_SHOW_SIDEBAR",{selected:l.contains(this.resizeHandlerNode,"pop-out")})}},hiddenSidebarWidth:null,render:function a(y){if(y){for(var z=0;z<this.sidebarNode.children.length-1;z++){l.remove(this.sidebarNode.children[z],"share-hidden")}this.resizer.unlock(true);var A=(this.hiddenSidebarWidth)?this.hiddenSidebarWidth:this.initialSidebarWidth;this.resizer.resize(null,200,A,0,0,true);if(this.resizeHandlerNode){l.remove(this.resizeHandlerNode,"pop-out");l.add(this.resizeHandlerNode,"pop-in")}}else{this.resizer.resize(null,200,9,0,0,true);this.resizer.lock(true);if(this.resizeHandlerNode){l.add(this.resizeHandlerNode,"pop-out");l.remove(this.resizeHandlerNode,"pop-in")}for(var z=0;z<this.sidebarNode.children.length-1;z++){l.add(this.sidebarNode.children[z],"share-hidden")}}}})});