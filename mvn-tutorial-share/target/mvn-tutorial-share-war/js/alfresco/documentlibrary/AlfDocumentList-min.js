define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dojo/text!./templates/AlfDocumentList.html","alfresco/core/Core","alfresco/core/CoreXhr","alfresco/core/PathUtils","alfresco/documentlibrary/_AlfDocumentListTopicMixin","alfresco/documentlibrary/_AlfHashMixin","alfresco/core/DynamicWidgetProcessingTopics","alfresco/services/_PreferenceServiceTopicMixin","alfresco/documentlibrary/views/AlfDocumentListView","dojo/_base/array","dojo/_base/lang","alfresco/menus/AlfCheckableMenuItem","dojo/dom-construct","dojo/dom-class"],function(d,c,i,f,o,L,p,O,M,b,N,A,g,e,w,J,r){return d([c,i,o,L,p,O,M,b,N],{nonAmdDependencies:["/js/alfresco.js"],i18nRequirements:[{i18nFile:"./i18n/AlfDocumentList.properties"}],cssRequirements:[{cssFile:"./css/AlfDocumentList.css"}],templateString:f,viewMap:null,viewControlsMap:null,widgets:null,postMixInProperties:function n(){this.alfPublish(this.getPreferenceTopic,{preference:"org.alfresco.share.documentList.documentsPerPage",callback:this.setPageSize,callbackScope:this});this.alfSubscribe(this.filterChangeTopic,e.hitch(this,"onChangeFilter"));this.alfSubscribe(this.viewSelectionTopic,e.hitch(this,"onViewSelected"));this.alfSubscribe(this.documentSelectionTopic,e.hitch(this,"onDocumentSelection"));this.alfSubscribe(this.sortRequestTopic,e.hitch(this,"onSortRequest"));this.alfSubscribe(this.sortFieldSelectionTopic,e.hitch(this,"onSortFieldSelection"));this.alfSubscribe(this.showFoldersTopic,e.hitch(this,"onShowFolders"));this.alfSubscribe(this.pageSelectionTopic,e.hitch(this,"onPageChange"));this.alfSubscribe(this.docsPerpageSelectionTopic,e.hitch(this,"onDocsPerPageChange"));this.alfSubscribe(this.reloadDataTopic,e.hitch(this,"loadData"));this.noViewSelectedMessage=this.message("doclist.no.view.message");this.noDataMessage=this.message("doclist.no.data.message");this.fetchingDataMessage=this.message("doclist.loading.data.message");this.renderingViewMessage=this.message("doclist.rendering.data.message")},setPageSize:function C(P){if(P==null){P=25}this.currentPageSize=P},postCreate:function l(){this.viewMap={};this.viewControlsMap={};if(this.widgets){this.processWidgets(this.widgets)}this.initialiseFilter()},allWidgetsProcessed:function q(P){var Q=this;g.forEach(P,e.hitch(this,"registerView"));this.alfPublish(this.viewSelectionTopic,{value:this._currentlySelectedView})},registerView:function H(P,Q){if(P.isInstanceOf(A)){this.alfLog("log","Registering DocumentList view",P);var S=P.getViewSelectionConfig();if(S==null||!this.isValidViewSelectionConfig(S)){this.alfLog("error","The following DocumentList view does not provide a valid selection menu item upon request",S)}else{var T=P.getViewName();if(T==null){T=Q}S.value=T;if(T==this.view){this._currentlySelectedView=T;S.checked=true}this.publishAdditionalControls(T,P);S.publishTopic=this.viewSelectionTopic;S.group=this.viewSelectionMenuItemGroup;var R=new w(S);this.alfPublish(this.selectionMenuItemTopic,{menuItem:R});this.viewMap[T]=P}}else{this.alfLog("warn","The following widget was provided as a view, but it does not inherit from 'alfresco/documentlibrary/AlfDocumentListView'",P)}},isValidViewSelectionConfig:function I(P){return(P.label!=null&&P.label!="")},_currentlySelectedView:null,_currentData:null,onViewSelected:function v(P){if(this._currentData==null){this.alfLog("warn","There is no data to render a view with");this.showNoDataMessage()}else{if(P==null||P.value==null){this.alfLog("warn","A request was made to select a view, but not enough information was provided",P)}else{if(this._currentlySelectedView==P.value){}else{if(this.viewMap[P.value]==null){this.alfLog("error","A request was made to select a non-existent view. Requested view: ",P.value," from: ",this.viewMap)}else{if(typeof this.viewMap[P.value].renderView==="function"){this._currentlySelectedView=P.value;var Q=this.viewMap[P.value];this.showRenderingMessage();Q.setData(this._currentData);Q.renderView();this.showView(Q)}else{this.alfLog("error","A view was requested that does not define a 'renderView' function",this.viewMap[P.value])}}}}}},publishAdditionalControls:function m(R,P){var Q=this.viewControlsMap[R];if(Q==null){Q=P.getAdditionalControls();this.viewControlsMap[R]=Q}if(Q!=null){this.alfPublish(this.dynamicallyAddWidgetTopic,{targetId:"DOCLIB_TOOLBAR",targetPosition:0,widgets:Q})}},hideChildren:function x(P){g.forEach(P.children,function(Q){r.add(Q,"share-hidden")})},showNoDataMessage:function u(){this.hideChildren(this.domNode);r.remove(this.noDataNode,"share-hidden")},showLoadingMessage:function k(){this.hideChildren(this.domNode);r.remove(this.dataLoadingNode,"share-hidden")},showRenderingMessage:function h(){this.hideChildren(this.domNode);r.remove(this.renderingViewNode,"share-hidden")},showView:function j(P){this.hideChildren(this.domNode);if(this.viewsNode.children.length>0){this.viewsNode.removeChild(this.viewsNode.children[0])}J.place(P.domNode,this.viewsNode);r.remove(this.viewsNode,"share-hidden");P.onViewShown()},onChangeDisplayedNode:function G(P){},onChangeFilter:function y(P){this.currentFilter=P;this.loadData()},loadData:function D(){this.showLoadingMessage();var Q=Alfresco.constants.URL_SERVICECONTEXT+"components/documentlibrary/data/doclist/"+this.buildDocListParams();var P={url:Q,method:"GET",successCallback:this.onDataLoadSuccess,failureCallback:this.onDataLoadFailure,callbackScope:this};this.serviceXhr(P)},onDataLoadSuccess:function K(R,Q){this.alfLog("log","Data Loaded",R,Q);for(var S=0;S<R.items.length;S++){R.items[S].jsNode=new Alfresco.util.Node(R.items[S].node)}this._currentData=R;this.alfPublish(this.documentsLoadedTopic,{documents:this._currentData.items,totalDocuments:this._currentData.totalRecords,startIndex:this._currentData.startIndex});if(this._currentData.metadata){this.alfPublish(this.metadataChangeTopic,{node:this._currentData.metadata})}var T=null;if(this._currentData.metadata&&this._currentData.metadata.parent&&this._currentData.metadata.parent.permissions&&this._currentData.metadata.parent.permissions.user){this.alfPublish(this.userAccessChangeTopic,{userAccess:this._currentData.metadata.parent.permissions.user})}var P=this.viewMap[this._currentlySelectedView];if(P!=null){this.showRenderingMessage();P.setData(this._currentData);P.renderView();this.showView(P);this.alfPublish("ALF_RESIZE_SIDEBAR",{})}},onDataLoadFailure:function K(Q,P){this.alfLog("error","Data Load Failed",Q,P);this._currentData=null;this.showNoDataMessage()},currentFilter:null,currentPage:1,currentPageSize:25,buildDocListParams:function z(T){var R={path:this.currentPath,type:this.showFolders?"all":"documents",site:this.siteId,container:this.containerId,filter:this.currentFilter};if(this.usePagination){R.page=this.currentPage;R.pageSize=this.currentPageSize}if(typeof T==="object"){R=e.mixin(R,T)}var P=(this.siteId!=null)?"{type}/site/{site}/{container}":"{type}/node/alfresco/company/home";if(R.filter.filterId==="path"){var Q=encodeURIComponent(R.filter.filterData).replace(/%2F/g,"/").replace(/%25/g,"%2525");P+=this.combinePaths("/",Q)}var S=e.replace(P,{type:encodeURIComponent(R.type),site:encodeURIComponent(R.site),container:encodeURIComponent(R.container)});S+="?filter="+encodeURIComponent(R.filter.filterId);if(R.filter.filterData&&R.filter.filterId!=="path"){S+="&filterData="+encodeURIComponent(R.filter.filterData)}if(this.usePagination){S+="&size="+R.pageSize+"&pos="+R.page}S+="&sortAsc="+this.sortAscending+"&sortField="+encodeURIComponent(this.sortField);if(this.siteId==null){S+="&libraryRoot="+encodeURIComponent(this.rootNode.toString())}S+="&view=browse&noCache="+new Date().getTime();return S},onDocumentSelection:function t(P){this.alfLog("log","Documents Selected: ",P)},onSortRequest:function E(P){this.alfLog("log","Sort requested: ",P);if(P&&P.direction){this.sortAscending=(P.direction=="ascending");this.loadData()}},onSortFieldSelection:function F(P){this.alfLog("log","Sort field selected: ",P);if(P&&P.value){this.sortField=P.value;this.loadData()}},onShowFolders:function a(P){this.alfLog("log","Show Folders Request: ",P);if(P&&P.selected!=null){this.showFolders=P.selected;this.loadData()}},onPageChange:function B(P){if(P&&P.value!=null&&P.value!=this.currentPage){this.currentPage=P.value;this.loadData()}},onDocsPerPageChange:function s(P){if(P&&P.value!=null&&P.value!=this.currentPageSize){if(this.currentPage==1){}else{if((this._currentData.totalRecords-P.value)<((this.currentPage-1)*P.value)){this.currentPage=Math.ceil(this._currentData.totalRecords/P.value)}else{}}this.currentPageSize=P.value;this.loadData()}}})});