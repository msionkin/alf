define(["dojo/_base/declare","alfresco/menus/AlfCascadingMenu","alfresco/core/CoreXhr","alfresco/menus/AlfMenuGroup","alfresco/menus/AlfMenuItem","dojo/_base/array"],function(g,a,e,k,c,j){return g([a,e],{i18nRequirements:[{i18nFile:"./i18n/AlfCreateTemplateContentMenu.properties"}],widgets:[{name:"alfresco/header/AlfMenuItem",config:{iconClass:"alf-loading-icon",label:"loading.label"}}],postCreate:function f(){this.inherited(arguments);if(this.label){this.set("label",this.message(this.label))}else{this.set("label",this.message("menu.label"))}if(this.popup){this.popup.onOpen=dojo.hitch(this,"loadTemplates")}else{this.alfLog("error","No menu popup - something has gone wrong!")}},_templatesUrl:null,_templatesLoaded:false,loadTemplates:function i(){if(this._favouritesLoaded){this.alfLog("log","Templates already loaded")}else{this.alfLog("log","Loading templates");var n=this._templatesUrl;if(n==null){n=Alfresco.constants.PROXY_URI+"slingshot/doclib/node-templates"}this.serviceXhr({url:n,method:"GET",successCallback:this._templatesLoaded,failureCallback:this._templatesLoadFailed,callbackScope:this})}},_templatesLoaded:function m(o,n){this.alfLog("log","Templates data loaded successfully",o);this._favouritesLoaded=true;var p=(this.popup&&this.popup.getChildren().length>0&&this.popup.getChildren()[0].focused);var r=this;j.forEach(this.popup.getChildren(),function(t,s){r.popup.removeChild(t)});if(o.data){if(o.data.length>0){var q=new k({});this.popup.addChild(q);j.forEach(o.data,dojo.hitch(this,"_addMenuItem",q))}else{this.addNoTemplatesMessageItem()}}if(p){this.popup.focusFirstChild()}},_templatesLoadFailed:function h(o,n){this.alfLog("error","Could not load templates menu items",o);var p=this;j.forEach(this.popup.getChildren(),function(r,q){p.popup.removeChild(r)});this.addTemplatesFailMessageItem()},addNoTemplatesMessageItem:function b(){this._templatesMessageItem=new c({label:"no.templates.label"});this.popup.addChild(this._templatesMessageItem)},addTemplatesFailMessageItem:function l(){this._templatesMessageItem=new c({label:"templates.load.error"});this.popup.addChild(this._templatesMessageItem)},templatePublishTopic:"ALF_CREATE_CONTENT",templateIconClass:"alf-textdoc-icon",_addMenuItem:function d(r,q,o){var n=(q.title!="")?q.title:q.name;var p=new c({label:n,iconClass:this.templateIconClass,publishTopic:this.templatePublishTopic,publishPayload:{type:"template",params:{nodeRef:q.nodeRef}}});r.addChild(p)}})});