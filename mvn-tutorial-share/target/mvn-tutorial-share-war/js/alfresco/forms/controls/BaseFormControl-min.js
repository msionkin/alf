define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_FocusMixin","dojo/text!./templates/BaseFormControl.html","dojo/dom-construct","alfresco/core/Core","alfresco/core/ObjectTypeUtils","dojo/_base/xhr","dojo/_base/lang","dojo/_base/array","dojo/dom-style","dojo/dom-class","dijit/focus","dijit/Tooltip","dojo/fx"],function(f,t,r,x,i,Q,v,p,Y,g,j,W,w,u,G,y){return f([t,r,x,v],{cssRequirements:[{cssFile:"./css/BaseFormControl.css"}],i18nRequirements:[{i18nFile:"./i18n/BaseFormControl.properties"}],templateString:i,wrappedWidget:null,pubSubScope:"",type:"",fieldId:"",label:"",unitsLabel:"",description:"",name:"",value:"",options:null,_visible:true,alfVisible:function L(aa){this.alfLog("log","Change visibility status for '"+this.name+"' to: "+aa);this._visible=aa;if(this.containerNode){var ab=aa?"block":"none";W.set(this.containerNode,{display:ab})}},_required:false,alfRequired:function q(aa){this.alfLog("log","Change requirement status for '"+this.name+"' to: "+aa,{});this._required=aa;if(this._requirementIndicator){var ab=aa?"block":"none";W.set(this._requirementIndicator,{display:ab});this.validate()}},_disabled:false,alfDisabled:function C(aa){this.alfLog("log","Change disablement status for '"+this.name+"' to: "+aa);this._disabled=aa;if(this.wrappedWidget){this.wrappedWidget.set("disabled",aa)}},visibilityConfig:null,requirementConfig:null,disablementConfig:null,functionMixins:null,constructor:function m(aa){f.safeMixin(this,aa);if(this.fieldId==null||this.fieldId==""){this.fieldId=this.generateUuid()}this.processFunctionMixins();this.processConfig("alfVisible",this.visibilityConfig);this.processConfig("alfRequired",this.requirementConfig);this.processConfig("alfDisabled",this.disablementConfig);this.processOptionsConfig(this.optionsConfig);if(this.validationConfig!=null&&typeof this.validationConfig.regex=="string"){this.validationConfig.regExObj=new RegExp(this.validationConfig.regex)}},processOptionsConfig:function E(ab){if(ab!=null){var aa=g.getObject("changesTo",false,ab);if(aa!=null){if(p.isArray(aa)){j.forEach(ab.changesTo,g.hitch(this,"createOptionsChangesTo",ab))}else{this.alfLog("warn","The supplied 'changesTo' attribute for '"+this.name+"' was not an Array")}}var ae=g.getObject("updateTopics",false,ab);if(ae!=null){if(p.isArray(ae)){j.forEach(ab.updateTopics,g.hitch(this,"createOptionsSubscriptions",ab))}else{this.alfLog("warn","The supplied 'changesTo' attribute for '"+this.name+"' was not an Array")}}var ad=g.getObject("makeXhr",false,ab),af=g.getObject("callback",false,ab),ac=g.getObject("fixed",false,ab);if(ad!=null){if(p.isString(ad)){this.getXhrOptions(ad)}else{this.alfLog("warn","The supplied 'makeXhr' attribute for '"+this.name+"' was not a String")}}else{if(af!=null){if(typeof af==="function"){this.options=af(ab);j.forEach(this.options,g.hitch(this,"processOptionLabel"))}else{if(p.isString(af)&&typeof this[af]==="function"){this.options=this[af](ab);j.forEach(this.options,g.hitch(this,"processOptionLabel"))}else{this.alfLog("warn","The supplied 'callback' attribute for '"+this.name+"' was not a Function")}}}else{if(ac!=null){if(p.isArray(ac)){this.options=ac;j.forEach(this.options,g.hitch(this,"processOptionLabel"))}else{this.alfLog("log","The supplied fixed options attribute for '"+this.name+"' was not an Array")}}}}}},processOptionLabel:function l(ab,aa){if(ab.label){ab.label=this.message(ab.label)}},createOptionsChangesTo:function H(ae,ad,ab){if(ad.targetId==null){this.alfLog("warn","No 'targetId' defined in subscription config",ad,config,this)}else{var aa="_valueChangeOf_"+ad.targetId,ac=(ad.global!=null?ad.global:false);this.alfSubscribe(aa,g.hitch(this,"updateOptions",ae),ac)}},createOptionsSubscriptions:function U(ad,ac,aa){if(ac.topic==null){this.alfLog("warn","No 'topic' defined in subscription config",ac,config,this)}else{var ab=(ac.global!=null?ac.global:false);this.alfSubscribe(ac.topic,g.hitch(this,"updateOptions",ad),ab)}},updateOptions:function B(ab,aa){this.alfLog("log","OPTIONS CONFIG: Field '"+this.name+"' is handling value change of field'"+aa.name);if(ab.makeXhr!=null){this.getXhrOptions(ab.makeXhr)}else{if(ab.callback!=null){if(typeof ab.callback=="function"){this.setOptions(ab.callback(ab,aa,this))}else{if(typeof ab.callback=="string"&&typeof this[ab.callback]=="function"){this.setOptions(this[ab.callback](ab,aa,this))}else{this.alfLog("log","The supplied 'callback' attribute for '"+_this.name+"' was neither a String nor a function")}}}}},getXhrOptions:function R(aa){var ab=this;Y.get({url:aa,handleAs:"json",load:function(ac){try{ab.setOptions(ac)}catch(ad){ab.alfLog("error","The following error occurred setting asynchronous results",ad);ab.setOptions([])}}})},_defaultOption:null,setOptions:function D(ab){this.alfLog("log","Setting options for field '"+this.name+"'",ab);var ac=this.getValue();this.options=ab;if(this.wrappedWidget){var aa=this.wrappedWidget.get("options");if(aa&&typeof this.wrappedWidget.removeOption==="function"){j.forEach(aa,g.hitch(this,"removeOption"))}if(typeof this.wrappedWidget.addOption==="function"){j.forEach(ab,g.hitch(this,"addOption"))}}this.setValue(ac)},removeOption:function S(ab,aa){this.wrappedWidget.removeOption(ab)},addOption:function X(ab,aa){this.processOptionLabel(ab,aa);this.wrappedWidget.addOption(ab)},getOptionsFromPublication:function z(ac,ab){var aa=g.getObject("options",false,ab);if(aa!=null&&p.isArray(aa)){return aa}else{return[]}},processConfig:function h(ab,aa){if(aa){if(typeof aa.initialValue!="undefined"){this[ab](aa.initialValue)}if(typeof aa.rules!="undefined"){this.processRulesConfig(ab,aa.rules)}else{if(typeof aa.rules!="undefined"){this.alfLog("log","The rules configuration for attribute '"+ab+"' for property '"+this.name+"' was not an Object")}}if(typeof aa.callbacks=="object"){this._processCallbacksConfig(ab,aa.callbacks)}else{if(typeof aa.callbacks!="undefined"){this.alfLog("log","The callback configuration for attribute '"+ab+"' for property '"+this.name+"' was not an Object")}}}},_rulesEngineData:null,processRulesConfig:function A(aa,ab){if(this._rulesEngineData==null){this._rulesEngineData={}}if(typeof this._rulesEngineData[aa]=="undefined"){this._rulesEngineData[aa]={}}j.forEach(ab,g.hitch(this,"processRule",aa))},processRule:function O(ab,ac,aa){if(ac.targetId!=null){if(typeof this._rulesEngineData[ab][ac.targetId]=="undefined"){this._rulesEngineData[ab][ac.targetId]={}}this._rulesEngineData[ab][ac.targetId].rules=ac;this.alfSubscribe("_valueChangeOf_"+ac.targetId,g.hitch(this,"evaluateRules",ab))}else{this.alfLog("warn","The following rule is missing a 'name' attribute",ac,this)}},evaluateRules:function I(aa,ae){this.alfLog("log","RULES EVALUATION('"+aa+"'): Field '"+this.name+"'");this._rulesEngineData[aa][ae.fieldId].currentValue=ae.value;var ac=true;var af=false;for(var ai in this._rulesEngineData[aa]){af=true;if(ac){var ah=this._rulesEngineData[aa][ai].currentValue;var ab=this._rulesEngineData[aa][ai].rules.is;var aj=this._rulesEngineData[aa][ai].rules.isNot;var ag=(typeof ab=="undefined"||ab.length==0);var ad=(typeof aj!="undefined"&&aj.length>0);if(ad){ad=j.some(aj,function(ak){return ak==ah})}if(!ad&&typeof ab!="undefined"&&ab.length>0){ag=j.some(ab,g.hitch(this,"ruleValueComparator",ah))}ac=ac&&ag&&!ad}}ac=ac&&af;this[aa](ac);return ac},ruleValueComparator:function s(aa,ab){this.alfLog("log","Comparing",aa,ab);if(aa!=null&&ab.value!=null){return aa.toString()==ab.value.toString()}else{return aa==ab.value}},_processCallbacksConfig:function T(ac,ab){var ad=this;for(var aa in ab){if(typeof ab[aa]=="function"){ad.alfSubscribe("_valueChangeOf_"+aa,function(af){var ae=ab[af.name](af.name,af.oldValue,af.value,ad,ac);ad[ac](ae)})}else{if(typeof ab[aa]=="string"&&typeof ad[ab[aa]]=="function"){ad.alfSubscribe(ad.pubSubScope+"_valueChangeOf_"+aa,function(af){var ae=ad[ab[af.name]](af.name,af.oldValue,af.value,ad,ac);ad[ac](ae)})}else{this.alfLog("log","The callback for property '"+ad.name+"' for handling changes to property '"+aa+"' was not a function or was not a String that references a local function")}}}},postCreate:function N(){var aa=this;this.initialConfig=this.getWidgetConfig();if(typeof this.initialConfig.disabled=="undefined"){this.initialConfig.disabled=this._disabled}this.wrappedWidget=this.createFormControl(this.initialConfig);if(this.isPromisedWidget&&typeof this.wrappedWidget.then==="function"){this.wrappedWidget.then(g.hitch(this,"onPromisedWidget"))}else{this.completeWidgetSetup()}},isPromisedWidget:false,onPromisedWidget:function o(aa){this.wrappedWidget=aa;this.completeWidgetSetup()},placeWidget:function n(){if(typeof this.wrappedWidget.placeAt==="function"){this.wrappedWidget.placeAt(this._controlNode)}else{this.alfLog("error","The wrapped widget has no 'placeAt' function - perhaps the 'placeWidget' function should be overridden?",this)}},completeWidgetSetup:function V(){this.placeWidget();this.setupChangeEvents();this.alfVisible(this._visible);this.alfRequired(this._required);this.alfDisabled(this._disabled);this._labelNode.innerHTML=this.encodeHTML(this.message(this.label));if(this.unitsLabel!=null&&this.unitsLabel!=""){this._unitsNode.innerHTML=this.encodeHTML(this.message(this.unitsLabel))}else{W.set(this._unitsNode,{display:"none"})}if(this.validationConfig!=null&&typeof this.validationConfig.errorMessage=="string"){this._validationMessage.innerHTML=this.encodeHTML(this.message(this.validationConfig.errorMessage))}if(this.wrappedWidget!=null&&this.description!=""){G.defaultPosition=["above","below"];var aa=new G({label:this.message(this.description),showDelay:250,connectId:[this.wrappedWidget.domNode]})}else{this.alfLog("log","Tooltip not created because form control not returned by call to createFormControl")}},setupChangeEvents:function V(){if(this.wrappedWidget){var aa=this.wrappedWidget.watch("value",g.hitch(this,"onValueChangeEvent"))}},onValueChangeEvent:function b(ab,aa,ac){this.formControlValueChange(ab,aa,ac);this.validate()},getValue:function k(){var aa=null;if(this.wrappedWidget){try{aa=this.wrappedWidget.getValue()}catch(ab){this.alfLog("log","An exception was thrown retrieving the value for field: '"+this.name+"'")}}this.alfLog("log","Returning value for field: '"+this.name+"': ",aa);return aa},setValue:function e(aa){this.alfLog("log","Setting field: '"+this.name+"' with value: ",aa);if(this.wrappedWidget){this.wrappedWidget.setValue(aa)}},publishValue:function F(){this.alfLog("log","Publishing value for field: '"+this.name+"'");if(this.wrappedWidget){this.alfPublish("_valueChangeOf_"+this.fieldId,{fieldId:this.fieldId,name:this.name,oldValue:this.getValue(),value:this.getValue()})}},formControlValueChange:function d(ab,aa,ac){this.alfPublish("_valueChangeOf_"+this.fieldId,{fieldId:this.fieldId,name:this.name,oldValue:aa,value:ac})},createFormControl:function K(aa){},getWidgetConfig:function M(){return{}},startup:function a(){},validationConfig:null,validate:function P(){var aa=this.processValidationRules();if(aa){this.alfPublish("_validFormControl",{name:this.name});this.hideValidationFailure()}else{this.alfPublish("_invalidFormControl",{name:this.name});this.showValidationFailure()}return aa},processValidationRules:function c(){var ab=this.getValue();this.alfLog("log","Validating: '"+this.name+"' with value:",ab);var aa=true,ac=true;aa=!(this._required&&(ab==null||ab==""));if(this.validationConfig!=null){if(typeof this.validationConfig.regExObj!="undefined"&&this.validationConfig.regExObj instanceof RegExp){ac=this.validationConfig.regExObj.test(ab)}}return aa&&ac},showValidationFailure:function Z(){w.add(this._validationIndicator,"validation-error");w.add(this._validationMessage,"display")},hideValidationFailure:function J(){w.remove(this._validationIndicator,"validation-error");w.remove(this._validationMessage,"display")}})});