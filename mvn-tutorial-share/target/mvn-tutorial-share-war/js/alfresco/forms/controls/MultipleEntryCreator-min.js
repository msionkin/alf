define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_FocusMixin","dojo/text!./templates/MultipleEntryCreator.html","alfresco/core/Core","alfresco/forms/controls/MultipleEntryElementWrapper","alfresco/forms/controls/MultipleEntryElement","dojo/_base/array","dijit/focus","dijit/registry","dojo/aspect","dojo/dnd/Source","dojo/dom-construct"],function(z,m,l,k,C,n,o,x,i,v,j,q,p,h){return z([m,l,n],{cssRequirements:[{cssFile:"./css/MultipleEntryCreator.css"}],i18nRequirements:[{i18nFile:"./i18n/MultipleEntryCreator.properties"}],templateString:C,constructor:function f(E){z.safeMixin(this,E);if(typeof this.value=="undefined"||this.value==null){this.value=[];this.elements=[]}else{if(this.value instanceof Array){this.elements=this.value}else{this.alfLog("log","The value assigned to the MultipleEntryCreator '"+this.name+"' was not a JSON array",this.value)}}},enableDND:false,_dndSource:null,dndCreator:function a(G,I){var E=this.getDNDType();var F;if(I==="avatar"){var H=this.getDNDAvatarWidget(G);F=this.createDNDAvatarNode(H)}else{F=this.createElementWrapper(G).domNode}return{node:F,data:G,type:E}},getDNDAvatarWidget:function s(E){var F=null;var G=this._dndSource.getSelectedNodes();i.forEach(G,function(I,H){var J=j.byNode(I);if(J&&J.widget&&J.widget.value&&E._alfMultipleElementId==J.widget.value._alfMultipleElementId){F=J.widget}else{this.alfLog("warn","MultipleEntryCreator.getDNDAvatarWidget function was expecting 'wrapper.widget.value._alfMultipleElementId' attribute:",J)}});return F},createDNDAvatarNode:function y(E){return h.create("div",{innerHTML:this.encodeHTML((E&&E.value&&E.value.value)?E.value.value:"")})},elements:null,elementWrappers:null,postCreate:function A(){if(this.enableDND){this._dndSource=new p(this.currentEntries,{copyOnly:false,selfCopy:false,selfAccept:true,accept:this.getAcceptedDNDTypes(),creator:dojo.hitch(this,"dndCreator")})}this.createEntries(this.elements)},getAcceptedDNDTypes:function g(){return[this.getDNDType()]},getDNDType:function B(){return"MultipleEntryElementWrapper"},createEntries:function t(E){if(E==null){E=[]}if(this.enableDND){this._dndSource.insertNodes(false,E)}else{this.alfLog("log","Creating entries for MultipleEntryCreator",E);i.forEach(E,function(G,F){if(G!=null&&G instanceof Object){var H=this.createElementWrapper(G);if(H.widget){H.widget.createReadDisplay()}}else{this.alfLog("log","An element in the value for MultipleEntryCreatory '"+this.name+"' was not an Object",G)}},this)}},createElementWrapper:function b(F){this.alfLog("log","Creating MultipleEntryElementWrapper",F);var H=this;var E=this.createElementWidget({pubSubScope:this.pubSubScope,dataScope:this.dataScope,elementConfig:F});var G=new o({creator:this,widget:E});q.after(G,"blurWrapper",function(I){H.alfLog("log","Wrapper 'blurWrapper' function processed");H.validationRequired()});G.placeAt(this.currentEntries);return G},validationRequired:function w(){this.alfLog("log","Validation Required function called")},createElementWidget:function D(E){var G=null;var F=[this.elementWidget];require(F,function(H){G=new H(E)});return G},addEntry:function u(G){var H;var F={};if(this.enableDND){this._dndSource.selectNone();this._dndSource.insertNodes(true,[F]);var E=this._dndSource.getSelectedNodes();if(E instanceof Array&&E.length>0){H=j.byNode(E[0]);if(H){H.editElement(G)}}}else{H=this.createElementWrapper(F);H.editElement(G);v.focus(H.widget)}return H},deleteEntry:function r(E){E.destroyRecursive()},getValue:function e(){var F=[];var E=j.findWidgets(this.currentEntries);i.forEach(E,function(I,G){var H=I.widget;if(typeof H.getValue=="function"){F.push(H.getValue())}else{this.alfLog("warn","The following widget has no getValue() function",H)}},this);return F},setValue:function c(F){this.alfLog("log","Setting value of MultipleEntryCreator",this,F);var E=j.findWidgets(this.currentEntries);i.forEach(E,function(H,G){H.destroyRecursive()});if(!F instanceof Array){this.alfLog("warn","The value provided to the MultipleEntryCreator setValue was not an array:",F)}else{this.createEntries(F)}},validate:function d(){var E=true;var F=j.findWidgets(this.currentEntries);var G=this;i.forEach(F,function(I,H){E=E&&I.widget.validate()});return E}})});