define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/form/Form","dojo/_base/xhr","alfresco/core/Core","dojo/text!./templates/Form.html","dojo/_base/lang","alfresco/buttons/AlfButton","dojo/_base/array","dojo/json","dijit/registry"],function(g,e,n,h,q,d,o,c,l,j,p,a){return g([e,n,d],{i18nRequirements:[{i18nFile:"./i18n/Form.properties"}],templateString:o,_form:null,widgets:null,postUrl:"",convertFormToJsonString:false,invalidFormControls:null,okButton:null,cancelButton:null,scopeFormControls:true,postCreate:function m(){this.invalidFormControls=[];if(this.scopeFormControls==true&&this.pubSubScope==""){this.pubSubScope=this.generateUuid()}this._form=new h({id:this.generateUuid()},this.formNode);this.alfSubscribe("_invalidFormControl",c.hitch(this,"onInvalidField"));this.alfSubscribe("_validFormControl",c.hitch(this,"onValidField"));if(this.widgets){this.processWidgets(this.widgets,this._form.domNode)}this.createButtons()},onInvalidField:function f(s){var r=j.some(this._invalidFormControls,function(t){return t==s.name});if(!r){this.invalidFormControls.push(s.name)}if(this.okButton){this.okButton.set("disabled","true")}},onValidField:function b(s){this.invalidFormControls=j.filter(this.invalidFormControls,function(t){return t!=s.name});if(this.okButton){this.okButton.set("disabled",this.invalidFormControls.length>0);var r=this.getValue();j.forEach(this.additionalButtons,function(u,t){if(u.publishPayload!=null){c.mixin(u.publishPayload,r)}else{u.publishPayload=r}})}},showOkButton:true,showCancelButton:true,okButtonLabel:"form.button.ok.label",okButtonPublishTopic:null,okButtonPublishPayload:null,cancelButtonLabel:"form.button.cancel.label",cancelButtonPublishTopic:null,cancelButtonPublishPayload:null,widgetsAdditionalButtons:null,additionalButtons:null,createButtons:function i(){if(this.showOkButton==true){this.okButton=new l({label:this.message(this.okButtonLabel),publishTopic:this.okButtonPublishTopic,publishPayload:this.okButtonPublishPayload},this.okButtonNode)}if(this.showCancelButton==true){this.cancelButton=new l({label:this.message(this.cancelButtonLabel),publishTopic:this.cancelButtonPublishTopic,publishPayload:this.cancelButtonPublishPayload},this.cancelButtonNode)}if(this.widgetsAdditionalButtons!=null){this.additionalButtons=[];this.processWidgets(this.widgetsAdditionalButtons,this.buttonsNode)}else{this.additionalButtons=a.findWidgets(this.buttonsNode)}},allWidgetsProcessed:function k(r){this.validate();if(this.widgetsAdditionalButtons!=null&&this.additionalButtons!=null&&this.additionalButtons.length==0){this.additionalButtons=a.findWidgets(this.buttonsNode)}},_onOK:function(){var s=this;var r={url:this.postUrl,handleAs:"json",load:function(t){s._onPostSuccess(t)},error:function(t){s._onPostFailure(t)}};if(this.convertFormToJsonString){r.headers={"Content-Type":"application/json"};r.postData=this._convertFormToJsonString()}else{r.form=this._form.id}q.post(r)},_convertFormToJsonString:function(){var r={};j.forEach(this._form.getChildren(),function(u,t){var s=u.get("name");if(s){var v=u.get("_wrappedWidget");r[u.get("name")]=v?(v.value?v.value:""):""}});return p.stringify(r)},_onPostSuccess:function(r){var s={response:r,form:this._form};this.alfPublish(this.id+"_POST_SUCCESS",s)},_onPostFailure:function(r){this.alfPublish(this.id+"_POST_FAILURE",r)},_onCancel:function(){this.alfPublish(this.id+"_CANCEL",null)},getValue:function(){var r={};if(this._form){j.forEach(this._form.getChildren(),function(t,s){r[t.get("name")]=t.getValue()})}this.alfLog("log","Returning form values: ",r);return r},setValue:function(r){this.alfLog("log","Setting form values: ",r);if(r&&r instanceof Object){if(this._form){j.forEach(this._form.getChildren(),function(t,s){t.setValue(r[t.get("name")])})}}},validate:function(){this.alfLog("log","Validating form",this._form);j.forEach(this._processedWidgets,function(s,r){if(s.publishValue&&typeof s.publishValue=="function"){s.validate();s.publishValue()}});j.forEach(this._processedWidgets,function(s,r){if(s.publishValue&&typeof s.publishValue=="function"){s.publishValue()}});return this.invalidFormControls.length==0}})});