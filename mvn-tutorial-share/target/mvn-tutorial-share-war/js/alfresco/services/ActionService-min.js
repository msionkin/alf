define(["dojo/_base/declare","alfresco/core/Core","alfresco/core/CoreXhr","alfresco/documentlibrary/_AlfDocumentListTopicMixin","alfresco/services/_NavigationServiceTopicMixin","alfresco/core/UrlUtils","alfresco/core/NotificationUtils","dojo/_base/lang","alfresco/wrapped/DocumentListToolbar","dojo/_base/array"],function(c,q,N,S,F,s,z,f,A,g){return c([q,N,S,F,s,z],{i18nScope:"Alfresco.DocListToolbar",i18nRequirements:[{i18nFile:"./i18n/ActionService.properties"}],cssRequirements:[{cssFile:"/components/documentlibrary/toolbar.css"},{cssFile:"/modules/social-publish.css"},{cssFile:"/modules/cloud/cloud-auth-form.css"},{cssFile:"/modules/cloud/cloud-folder-picker.css"},{cssFile:"/modules/cloud/cloud-sync-status.css"},{cssFile:"/modules/documentlibrary/aspects.css"},{cssFile:"/modules/documentlibrary/copy-to.css"},{cssFile:"/modules/documentlibrary/global-folder.css"},{cssFile:"/modules/documentlibrary/permissions.css"},{cssFile:"/modules/documentlibrary/site-folder.css"},{cssFile:"/components/object-finder/object-finder.css"}],nonAmdDependencies:["/modules/social-publish.js","/modules/documentlibrary/global-folder.js","/modules/documentlibrary/doclib-actions.js","/modules/documentlibrary/copy-move-to.js","/modules/documentlibrary/permissions.js","/components/download/archive-and-download.js","/modules/documentlibrary/cloud-folder.js","/modules/cloud-auth.js","/components/documentlibrary/actions.js","/components/documentlibrary/toolbar.js","/components/form/form.js","/components/form/date.js","/components/form/date-picker.js","/components/form/period.js","/components/object-finder/object-finder.js","/yui/calendar/calendar.js","/modules/editors/tiny_mce/tiny_mce.js","/modules/editors/tiny_mce.js","/components/form/rich-text.js","/components/form/content.js","/components/form/workflow/transitions.js","/components/form/workflow/activiti-transitions.js","/components/form/jmx/operations.js","/modules/documentlibrary/doclib-actions.js","/modules/simple-dialog.js"],siteId:null,containerId:null,rootNode:null,_legacyToolbar:null,getLegacyToolbar:function C(){return this.toolbar},constructor:function G(T){f.mixin(this,T);this.toolbar=new Alfresco.DocListToolbar(this.id,false).setOptions({siteId:this.siteId,rootNode:this.rootNode});this.toolbar.onReady();this.loadCustomActionHandlers();this.subscribeToLegacyEvents();this.currentlySelectedDocuments={};this.alfSubscribe(this.documentsLoadedTopic,f.hitch(this,"onDocumentsLoaded"));this.alfSubscribe(this.metadataChangeTopic,f.hitch(this,"handleCurrentNodeChange"));this.alfSubscribe(this.documentSelectedTopic,f.hitch(this,"onDocumentSelected"));this.alfSubscribe(this.documentDeselectedTopic,f.hitch(this,"onDocumentDeselected"));this.alfSubscribe(this.singleDocumentActionTopic,f.hitch(this,"handleSingleDocAction"));this.alfSubscribe(this.syncLocationTopic,f.hitch(this,"onSyncLocation"));this.alfSubscribe(this.unsyncLocationTopic,f.hitch(this,"onUnsyncLocation"));this.alfSubscribe("ALF_MULTIPLE_DOCUMENT_ACTION_REQUEST",f.hitch(this,"handleMultiDocLegacyAction"));this.alfSubscribe("ALF_CREATE_CONTENT",f.hitch(this,"processActionObject"));this.alfSubscribe("ALF_MOVE_DOCUMENTS",f.hitch(this,"onMoveDocuments"))},subscribeToLegacyEvents:function d(){YAHOO.Bubbling.on("fileCopied",this.onFileAction,this);YAHOO.Bubbling.on("fileDeleted",this.onFileAction,this);YAHOO.Bubbling.on("fileMoved",this.onFileAction,this);YAHOO.Bubbling.on("filePermissionsUpdated",this.onFileAction,this);YAHOO.Bubbling.on("folderCopied",this.onFileAction,this);YAHOO.Bubbling.on("folderDeleted",this.onFileAction,this);YAHOO.Bubbling.on("folderMoved",this.onFileAction,this);YAHOO.Bubbling.on("folderPermissionsUpdated",this.onFileAction,this);YAHOO.Bubbling.on("filesCopied",this.requestRefresh,this);YAHOO.Bubbling.on("filesDeleted",this.requestRefresh,this);YAHOO.Bubbling.on("filesMoved",this.requestRefresh,this);YAHOO.Bubbling.on("filesPermissionsUpdated",this.requestRefresh,this)},onFileAction:function R(U,T){var V=T[1];if(V){if(!V.multiple){this.requestRefresh()}}},requestRefresh:function(){this.alfPublish(this.reloadDataTopic,{})},loadCustomActionHandlers:function a(){if(this.customAggregatedJsResource){require([Alfresco.constants.URL_RESCONTEXT+this.customAggregatedJsResource],f.hitch(this,"customActionHandlersLoaded"))}},customActionHandlersLoaded:function(){this.alfLog("log","Custom action handlers loaded")},onDocumentsLoaded:function p(T){this.alfLog("log","New Documents Loaded",T);this.currentlySelectedDocuments={};this.onSelectedFilesChanged()},_currentNode:null,handleCurrentNodeChange:function v(T){if(T&&T.node){this.alfLog("log","Updating current nodeRef to: ",T.node);this._currentNode=T.node;this.getLegacyToolbar().doclistMetadata.parent=T.node}else{this.alfLog("error","A request was made to update the current NodeRef, but no 'node' property was provided in the payload: ",T)}},handleSingleDocAction:function O(T){this.alfLog("log","Single document action request:",T);if(T&&T.document!=null&&T.action!=null){if(typeof T.action==="string"){if(typeof this.toolbar[T.action]==="function"){this.toolbar[T.action].call(this.toolbar,T.document)}else{if(typeof this[T.action]==="function"){this[T.action](T.document)}}}else{if(typeof T.action==="object"){this.processActionObject(T.action,T.document)}}}},handleMultiDocLegacyAction:function D(T){this.alfLog("log","Multiple document action request:",T);if(T&&T.action){if(typeof this.getLegacyToolbar()[T.action]==="function"){this.alfLog("log","Found legacy action handler");if(this.currentlySelectedDocuments!=null){this.getLegacyToolbar()[T.action].call(this.getLegacyToolbar(),this.getSelectedDocumentArray())}else{this.alfLog("log","No documents selected to perform an action on")}}else{this.alfLog("error","A request was made to perform an action on multiple documents, but the JavaScript handler could not be found: ",T.action)}}else{this.alfLog("error","A request was made to perform an action on multiple documents, but no action was provided: ",T)}},_callLegacyActionHandler:function k(U,V,T){this.alfLog("log","Calling handler",U,V,T);U.call(this.getLegacyToolbar(),V)},currentlySelectedDocuments:null,selectionTimeout:null,onDocumentSelected:function J(T){if(T&&T.value&&T.value.nodeRef!=null){this.currentlySelectedDocuments[T.value.nodeRef]=T.value;if(this.selectionTimeout!=null){clearTimeout(this.selectionTimeout)}this.selectionTimeout=setTimeout(f.hitch(this,"deferredSelectionHandler"),50)}},deferredSelectionHandler:function B(){this.onSelectedFilesChanged();this.selectionTimeout=null},onDocumentDeselected:function n(T){if(T&&T.value&&T.value.nodeRef!=null){delete this.currentlySelectedDocuments[T.value.nodeRef];if(this.selectionTimeout!=null){clearTimeout(this.selectionTimeout)}this.selectionTimeout=setTimeout(f.hitch(this,"deferredSelectionHandler"),50)}},getSelectedDocumentArray:function H(){var T=[];for(var U in this.currentlySelectedDocuments){T.push(this.currentlySelectedDocuments[U])}return T},onSelectedFilesChanged:function i(){var T=this.getSelectedDocumentArray(),W=[],X,ag,af={},U,ac,Y=[],ad=[],aa,ae,Z,ab;var V=function V(ah){return(ah.node.isContainer?"folder":"document")};for(aa=0,ae=T.length;aa<ae;aa++){X=T[aa];U=X.node.permissions.user;for(ac in U){if(U.hasOwnProperty(ac)){af[ac]=(af[ac]===undefined?U[ac]:af[ac]&&U[ac])}}ag=V(X);if(!(ag in W)){W[ag]=true;W.push(ag)}if(aa===0){Y=Alfresco.util.deepCopy(X.node.aspects)}else{for(Z=0,ab=Y.length;Z<ab;Z++){if(!Alfresco.util.arrayContains(X.node.aspects,Y[Z])){Alfresco.util.arrayRemove(Y,Y[Z])}}}for(Z=0,ab=X.node.aspects.length;Z<ab;Z++){if(!Alfresco.util.arrayContains(ad,X.node.aspects[Z])){ad.push(X.node.aspects[Z])}}}this.alfPublish(this.selectedDocumentsChangeTopic,{selectedFiles:T,userAccess:af,commonAspects:Y,allAspects:ad})},processActionObject:function Q(U,T){if(U&&U.type){if(U.type=="pagelink"){if(U.params.page){this.createPageLinkContent(U,T)}else{this.alfLog("error","A request was made to perform an action. The 'pagelink' type was requested, but no 'page' attribute was provided: ",U)}}else{if(U.type=="link"){if(U.params.href){this.createLinkContent(U,T)}else{this.alfLog("error","A request was made to perform an action. The 'link' type was requested, but no 'href' attribute was provided: ",U)}}else{if(U.type=="javascript"){if(U.params["function"]){this.createJavaScriptContent(U,T)}else{this.alfLog("error","A request was made to perform an action. The 'javascript' type was requested, but no 'function' attribute was provided: ",U)}}else{if(U.type=="template"){if(U.params.nodeRef){this.createTemplateContent(U,T)}else{this.alfLog("error","A request was made to perform an action. The 'template' type was requested, but no 'nodeRef' attribute was provided: ",U)}}else{this.alfLog("error","A request was made to perform an action, but an unknown 'type' was provided: ",U)}}}}}else{this.alfLog("error","A request was made to perform an action, but no 'type' was provided in the payload: ",U)}},createPageLinkContent:function l(V,T){var U=V.params.page;if(T!=null){U=f.replace(U,T)}else{if(this._currentNode!=null){U=f.replace(U,{nodeRef:this._currentNode.parent.nodeRef})}}this.alfPublish(this.navigateToPageTopic,{type:this.sharePageRelativePath,url:U,target:this.currentTarget})},createLinkContent:function x(U,T){this.alfPublish(this.navigateToPageTopic,{type:this.fullPath,url:f.replace(U.params.href,this.getActionUrls(T,this.siteId,this.repositoryUrl,this.replicationUrlMapping)),target:this.currentTarget})},createJavaScriptContent:function y(W,T){if(Alfresco&&Alfresco.util&&typeof Alfresco.util.deepCopy==="function"&&typeof Alfresco.util.Node==="function"){if(T==null){var U=Alfresco.util.deepCopy(this._currentNode.parent);T={nodeRef:U.nodeRef,node:U,jsNode:new Alfresco.util.Node(U)}}}var V=this[W.params["function"]];if(typeof V==="function"){V.call(this,W,T)}else{this.callLegacyActionHandler(W.params["function"],T)}},callLegacyActionHandler:function t(V,T){var U=this.getLegacyToolbar()[V];if(typeof U==="function"){U.call(this.getLegacyToolbar(),T)}else{this.alfLog("error","A request was made to perform an action but supplied function name does not map to a known function",V)}},onActionDetails:function I(U,T){this.callLegacyActionHandler("onActionDetails",T)},onActionUploadNewVersion:function u(U,T){this.callLegacyActionHandler("onActionUploadNewVersion",T)},onActionEditOffline:function r(W,T){if(T!=null&&T.jsNode!=null&&T.jsNode.nodeRef!=null){var V={nodeRef:T.jsNode.nodeRef.uri};var U={url:Alfresco.constants.PROXY_URI+"slingshot/doclib/action/checkout/node/"+T.jsNode.nodeRef.uri,method:"POST",data:V,successCallback:this.onActionEditOfflineSuccess,failureCallback:this.onActionEditOfflineFailure,callbackScope:this};this.serviceXhr(U)}else{this.alfLog("error","A request was made to edit a document offline, but the document supplied does not contain enough information",T)}},onActionEditOfflineSuccess:function w(U,T){this.alfLog("log","Edit offline request success",U,T);if(U!=null&&U.results!=null&&U.results.length>0&&U.results[0].downloadUrl!=null){this.displayMessage(this.message("message.edit-offline.success",{"0":U.results[0].id}));this.alfPublish(this.navigateToPageTopic,{url:Alfresco.constants.PROXY_URI+U.results[0].downloadUrl,type:this.fullPath});this.alfPublish(this.reloadDataTopic,{})}else{this.alfLog("error","A request to edit a document offline returned a successful response but did not provide a 'downloadUrl' attribute",U,T)}},onActionEditOfflineFailure:function w(U,T){this.alfLog("error","Edit offline request failure",U,T);this.displayMessage(this.message("message.edit-offline.failure",{"0":U.results[0].id}))},onActionCopyTo:function h(U,T){this.callLegacyActionHandler("onActionCopyTo",T)},onActionMoveTo:function b(U,T){this.callLegacyActionHandler("onActionMoveTo",T)},onActionDelete:function E(U,T){this.callLegacyActionHandler("onActionDelete",T)},onActionAssignWorkflow:function L(U,T){this.callLegacyActionHandler("onActionAssignWorkflow",T)},onActionPublish:function o(U,T){this.callLegacyActionHandler("onActionPublish",T)},createTemplateContent:function e(X){var W=X.params.nodeRef,T=this._currentNode.parent.nodeRef;if(W){var V=Alfresco.constants.PROXY_URI+"slingshot/doclib/node-templates",U={parentNodeRef:T,sourceNodeRef:W};this.serviceXhr({url:V,node:W,data:U,method:"POST",successCallback:this.templateContentCreateSuccess,failureCallback:this.templateContentCreateFailure,callbackScope:this})}},templateContentCreateSuccess:function K(U,T){this.displayMessage(this.message("message.create-content-by-template-node.success",U.name));this.alfPublish("ALF_NODE_CREATED",{name:U.name,parentNodeRef:T.data.parentNodeRef,highlightFile:U.name})},templateContentCreateFailure:function K(U,T){this.displayMessage(this.message("message.create-content-by-template-node.failure",U.name))},onSyncLocation:function P(V){var U=Alfresco.util.deepCopy(this._currentNode.parent);var T={nodeRef:U.nodeRef,displayName:U.properties["cm:name"],jsNode:new Alfresco.util.Node(U)};this.callLegacyActionHandler("onActionCloudSync",T)},onUnsyncLocation:function m(V){var U=Alfresco.util.deepCopy(this._currentNode.parent);var T={nodeRef:U.nodeRef,displayName:U.properties["cm:name"],jsNode:new Alfresco.util.Node(U)};this.callLegacyActionHandler("onActionCloudUnsync",T)},onMoveDocuments:function j(W){if(W&&W.sourceNodeRefs!=null){var U=null;if(W.targetNodeRefUri!=null){U=Alfresco.constants.PROXY_URI+"slingshot/doclib/action/move-to/node/"+W.targetNodeRefUri}else{if(W.targetPath!=null){if(this.rootNode!=null){var V=new Alfresco.util.Node(this.rootNode).nodeRef.uri;U=Alfresco.constants.PROXY_URI+"slingshot/doclib/action/move-to/node/"+V+W.targetPath}else{U=Alfresco.constants.PROXY_URI+"slingshot/doclib/action/move-to/site/"+this.siteId+"/"+this.containerId+"/"+W.targetPath}}}if(U!=null){var T={nodeRefs:W.sourceNodeRefs,parentId:this._currentNode.parent.nodeRef};this.serviceXhr({url:U,data:T,method:"POST",successCallback:this.onMoveDocumentsSuccess,failureCallback:this.onMoveDocumentsFailure,callbackScope:this})}else{this.alfLog("warn","Could not process a request to move documents due to missing attributes, either 'targetNodeRefUri' or 'targetPath' is required",W)}}},onMoveDocumentsSuccess:function M(U,T){this.alfPublish(this.reloadDataTopic,{})},onMoveDocumentsFailure:function M(U,T){}})});