define(["dojo/_base/declare","alfresco/core/Core","alfresco/core/CoreXhr","alfresco/core/NotificationUtils","dojo/request/xhr","dojo/json","dojo/_base/lang","dojo/dom-construct","alfresco/buttons/AlfButton"],function(x,q,u,w,l,d,B,j,s){return x([q,u,w],{i18nRequirements:[{i18nFile:"./i18n/SiteService.properties"}],constructor:function a(C){B.mixin(this,C);this.alfSubscribe("ALF_GET_SITE_DETAILS",B.hitch(this,"getSiteDetails"));this.alfSubscribe("ALF_BECOME_SITE_MANAGER",B.hitch(this,"becomeSiteManager"));this.alfSubscribe("ALF_JOIN_SITE",B.hitch(this,"joinSite"));this.alfSubscribe("ALF_REQUEST_SITE_MEMBERSHIP",B.hitch(this,"requestSiteMembership"));this.alfSubscribe("ALF_LEAVE_SITE",B.hitch(this,"leaveSiteRequest"));this.alfSubscribe("ALF_LEAVE_SITE_CONFIRMATION",B.hitch(this,"leaveSite"));this.alfSubscribe("ALF_CREATE_SITE",B.hitch(this,"createSite"));this.alfSubscribe("ALF_EDIT_SITE",B.hitch(this,"editSite"));this.alfSubscribe("ALF_ADD_FAVOURITE_SITE",B.hitch(this,"addSiteAsFavourite"));this.alfSubscribe("ALF_REMOVE_FAVOURITE_SITE",B.hitch(this,"removeSiteFromFavourites"));var D=this;require([Alfresco.constants.URL_RESCONTEXT+"modules/edit-site.js"],function(){D.alfLog("log","Edit Site JavaScript resource loaded")})},getSiteDetails:function e(D){if(D&&D.site&&D.responseTopic){var C=Alfresco.constants.PROXY_URI+"api/sites/"+D.site;this.serviceXhr({url:C,method:"GET",site:D.site,responseTopic:D.responseTopic,successCallback:this.publishSiteDetails,callbackScope:this})}else{this.alfLog("error","A request to get the details of a site was made, but either the 'site' or 'responseTopic' attributes was not provided",D)}},publishSiteDetails:function z(D,C){if(C&&C.responseTopic){this.alfLog("log","Publishing site details",C);this.alfPublish(C.responseTopic,D)}else{this.alfLog("error","It was not possible to publish requested site details because the 'responseTopic' attribute was not set on the original request",D,C)}},addSiteAsFavourite:function y(E){if(E.site&&E.user){var D=Alfresco.constants.PROXY_URI+"api/people/"+encodeURIComponent(E.user)+"/preferences",C={org:{alfresco:{share:{sites:{favourites:{}}}}}};C.org.alfresco.share.sites.favourites[E.site]=true;this.serviceXhr({url:D,site:E.site,user:E.user,data:C,method:"POST",successCallback:this.favouriteSiteAdded,callbackScope:this})}else{this.alfLog("error","A request to make a site a favourite but either the site or user was not specified",E)}},favouriteSiteAdded:function i(D,C){this.alfLog("log","Favourite Site Added Successfully",D,C);this.alfPublish("ALF_FAVOURITE_SITE_ADDED",{site:C.site,user:C.user})},removeSiteFromFavourites:function o(D){if(D.site&&D.user){var C=Alfresco.constants.PROXY_URI+"api/people/"+encodeURIComponent(D.user)+"/preferences?pf=org.alfresco.share.sites.favourites."+D.site;this.serviceXhr({url:C,site:D.site,user:D.user,method:"DELETE",successCallback:this.favouriteSiteRemoved,callbackScope:this})}else{this.alfLog("error","A request to remove a site from the favourites list but either the site or user was not specified",D)}},favouriteSiteRemoved:function b(D,C){this.alfLog("log","Favourite Site Removed Successfully",D,C);this.alfPublish("ALF_FAVOURITE_SITE_REMOVED",{site:C.site,user:C.user})},becomeSiteManager:function f(D){if(D.site){this.alfLog("log","A request has been made for a user to become the manager of a site: ",D);var C=Alfresco.constants.PROXY_URI+"api/sites/"+encodeURIComponent(D.site)+"/memberships";var E={role:(D.role)?D.role:"SiteManager",person:{userName:D.user}};this.serviceXhr({url:C,data:E,method:"POST",successCallback:this.reloadPage,callbackScope:this})}else{this.alfLog("error","A request was made for a user to become the manager of a site, but no site was specified",D)}},requestSiteMembership:function A(D){if(D.site&&D.user){this.alfLog("log","A request has been made for a user to join a site: ",D);var C=Alfresco.constants.PROXY_URI+"api/sites/"+encodeURIComponent(D.site)+"/invitations";var E={invitationType:"MODERATED",inviteeRoleName:(D.role)?D.role:"SiteConsumer",inviteeUserName:D.user,inviteeComments:(D.comments)?D.comments:""};this.serviceXhr({url:C,method:"POST",site:D.site,user:D.user,data:E,successCallback:this.siteMembershipRequestComplete,callbackScope:this})}else{if(!D.site){this.alfLog("error","A request was made to join a site but no site was specified",D)}if(!D.user){this.alfLog("error","A request was made to join a site but no user was specified",D)}}},siteMembershipRequestComplete:function p(D,C){this.alfLog("log","User has successfully requested to join a moderated site",D,C);this.displayPrompt({title:"",textContent:this.message("message.request-join-success",{"0":C.user,"1":C.site}),widgetsButtons:[{name:"alfresco/buttons/AlfButton",config:{label:this.message("label.ok"),publishTopic:"ALF_NAVIGATE_TO_PAGE",publishPayload:{url:"user/"+C.user+"/dashboard",type:"SHARE_PAGE_RELATIVE",target:"CURRENT"}}}]})},joinSite:function k(D){if(D.site&&D.user){this.alfLog("log","A request has been made for a user to join a site: ",D);var C=Alfresco.constants.PROXY_URI+"api/sites/"+encodeURIComponent(D.site)+"/memberships";var E={role:(D.role)?D.role:"SiteConsumer",person:{userName:D.user}};this.serviceXhr({url:C,method:"PUT",site:D.site,user:D.user,data:E,successCallback:this.siteJoined,callbackScope:this})}else{if(!D.site){this.alfLog("error","A request was made to join a site but no site was specified",D)}if(!D.user){this.alfLog("error","A request was made to join a site but no user was specified",D)}}},siteJoined:function c(D,C){this.alfLog("log","User has successfully joined a site",D,C);this.alfPublish("ALF_SITE_JOINED",{site:C.site,user:C.user});this.reloadPage()},createSite:function h(C){this.alfLog("log","A request has been made to create a site: ",C);if(Alfresco&&Alfresco.module&&typeof Alfresco.module.getCreateSiteInstance==="function"){Alfresco.module.getCreateSiteInstance().show()}else{this.alfLog("error","Could not find the 'Alfresco.module.getCreateSiteInstance' function - has 'create-site.js' been included in the page?")}},editSite:function h(C){this.alfLog("log","A request has been made to edit a site: ",C);if(Alfresco&&Alfresco.module&&typeof Alfresco.module.getEditSiteInstance==="function"){Alfresco.module.getEditSiteInstance().show({shortName:C.site})}else{this.alfLog("error","Could not find the 'Alfresco.module.getEditSiteInstance' function - has 'edit-site.js' been included in the page?")}},leaveSiteRequest:function g(C){this.displayPrompt({title:this.message("message.leave",{"0":C.siteTitle}),textContent:this.message("message.leave-site-prompt",{"0":C.siteTitle}),widgetsButtons:[{name:"alfresco/buttons/AlfButton",config:{label:this.message("button.leave-site.confirm-label"),publishTopic:"ALF_LEAVE_SITE_CONFIRMATION",publishPayload:C}},{name:"alfresco/buttons/AlfButton",config:{label:this.message("button.leave-site.cancel-label"),publishTopic:"ALF_LEAVE_SITE_CANCELLATION",publishPayload:C}}]})},leaveSite:function v(D){if(D.site&&D.user){this.alfLog("log","A request has been made for a user to leave a site: ",D);var C=Alfresco.constants.PROXY_URI+"api/sites/"+encodeURIComponent(D.site)+"/memberships/"+encodeURIComponent(D.user);this.serviceXhr({url:C,method:"DELETE",site:D.site,siteTitle:D.siteTitle,user:D.user,userFullName:D.userFullName,successCallback:this.siteLeft,failureCallback:this.siteLeftFailure,callbackScope:this})}else{if(!D.site){this.alfLog("error","A request was made to leave a site but no site was specified",D)}if(!D.user){this.alfLog("error","A request was made to leave a site but no user was specified",D)}}},siteLeft:function t(D,C){this.alfLog("log","User has successfully left a site",D,C);this.displayMessage(this.message("message.leaving",{"0":C.userFullName,"1":C.siteTitle}));this.alfPublish("ALF_SITE_LEFT",{site:C.site,user:C.user});this.leaveSiteSuccess()},siteLeftFailure:function n(D,C){this.alfLog("log","User has failed to leave a site",D,C);this.displayMessage(this.message("message.leave-failure",{"0":C.userFullName,"1":C.siteTitle}))},reloadPage:function r(D,C){this.alfPublish("ALF_RELOAD_PAGE",{})},leaveSiteSuccess:function m(D,C){window.location.href=Alfresco.constants.URL_CONTEXT}})});