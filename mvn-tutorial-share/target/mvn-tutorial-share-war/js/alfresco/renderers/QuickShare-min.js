define(["dojo/_base/declare","alfresco/renderers/Toggle","alfresco/services/_QuickShareServiceTopicMixin","dojo/text!./templates/QuickShare.html","dojo/_base/lang","dojo/_base/array","dojo/dom-class","dijit/registry","alfresco/menus/AlfMenuBar","alfresco/menus/AlfMenuBarPopup","alfresco/menus/AlfCascadingMenu","alfresco/menus/AlfMenuGroup","alfresco/menus/AlfMenuItem","alfresco/menus/AlfMenuTextForClipboard"],function(s,o,f,w,x,g,k,h,d,b,v,c,q,u){return s([o,f],{i18nRequirements:[{i18nFile:"./i18n/QuickShare.properties"}],cssRequirements:[{cssFile:"./css/QuickShare.css"}],templateString:w,onLabel:"quick-share.enabled.label",offLabel:"quick-share.disabled.label",onTooltip:"quick-share.enabled.description",offTooltip:"quick-share.disabled.description",toggleClass:"quick-share",postMixInProperties:function t(){this.toggleOnTopic=(this.toggleOnTopic!=null)?this.toggleOnTopic:this.addQuickShareTopic;this.toggleOnSuccessTopic=(this.toggleOnSuccessTopic!=null)?this.toggleOnSuccessTopic:this.addQuickShareSuccessTopic;this.toggleOnFailureTopic=(this.toggleOnFailureTopic!=null)?this.toggleOnFailureTopic:this.addQuickShareFailureTopic;this.toggleOffTopic=(this.toggleOffTopic!=null)?this.toggleOffTopic:this.removeQuickShareTopic;this.toggleOffSuccessTopic=(this.toggleOffSuccessTopic!=null)?this.toggleOffSuccessTopic:this.removeQuickShareSuccessTopic;this.toggleOffFailureTopic=(this.toggleOffFailureTopic!=null)?this.toggleOffFailureTopic:this.removeQuickShareFailureTopic;this.alfSubscribe(this.toggleOffTopic,x.hitch(this,"renderToggledOff"));this.inherited(arguments)},getInitialState:function i(){return typeof this.currentItem.jsNode.properties["qshare:sharedId"]!="undefined"},postCreate:function l(){this.inherited(arguments);if(this.currentItem.node!=null&&this.currentItem.node.isContainer){k.add(this.domNode,"hidden")}else{this.alfPublish(this.getQuickShareLinkTopic,{callback:this.setQuickShareLink,callbackScope:this});this.alfPublish(this.getSocialLinksTopic,{callback:this.setSocialLinks,callbackScope:this});if(this.isToggleOn){this.widgets=this.defineWidgets(this.currentItem.jsNode.properties["qshare:sharedId"]);this.processWidgets(this.widgets,this.onNode)}}},setQuickShareLink:function j(y){this.quickShareLink=y},setSocialLinks:function r(y){this.socialLinks=y},onToggleOnSuccess:function a(y){this.inherited(arguments);this.widgets=this.defineWidgets(y.response.sharedId);this.processWidgets(this.widgets,this.onNode)},onToggleOffSuccess:function n(z){this.inherited(arguments);if(this.onNode.children!=null&&this.onNode.children.length>0){var y=h.byNode(this.onNode.children[0]);y.destroy()}},defineWidgets:function p(z){var A="http://"+window.location.host+this.quickShareLink.replace("{sharedId}",z);var y=[{name:"alfresco/menus/AlfMenuBar",config:{widgets:[{name:"alfresco/menus/AlfMenuBarPopup",config:{label:this.message("quick-share.enabled.label"),iconClass:"alf-quick-share-enabled-icon",widgets:[{name:"alfresco/menus/AlfMenuGroup",config:{widgets:[{name:"alfresco/menus/AlfCascadingMenu",config:{label:this.message("quick-share.public-url.label"),widgets:[{name:"alfresco/menus/AlfMenuGroup",config:{widgets:[{name:"alfresco/menus/AlfMenuTextForClipboard",config:{textForClipboard:A}}]}}]}},{name:"alfresco/menus/AlfMenuItem",config:{label:this.message("quick-share.view.label"),publishTopic:"ALF_NAVIGATE_TO_PAGE",publishPayload:{url:A,type:"FULL_PATH",target:"NEW"}}},{name:"alfresco/menus/AlfMenuItem",config:{label:this.message("quick-share.unshare.label"),publishTopic:this.toggleOffTopic,publishPayload:{node:this.currentItem,sharedId:z}}},{name:"alfresco/menus/AlfCascadingMenu",config:{label:this.message("quick-share.share-with.label"),widgets:[{name:"alfresco/menus/AlfMenuGroup",config:{widgets:this.defineSocialLinkWidgets(A)}}]}}]}}]}}]}}];return y},defineSocialLinkWidgets:function m(z){var y=[];if(this.socialLinks!=null){g.forEach(this.socialLinks,x.hitch(this,"defineSocialLinkWidget",y,z))}return y},defineSocialLinkWidget:function e(C,E,z,A){if(z.id!=null&&z.params!=null){var y=null;for(var B=0;B<z.params.length;B++){if(typeof z.params[B].href!="undefined"){y=z.params[B].href}}if(y!=null){var F=x.replace(y,x.hitch(this,"substituteSocialConfigTokens",z.id,E));var D={name:"alfresco/menus/AlfMenuItem",config:{label:this.message("linkshare.action."+z.id+".label"),iconClass:"alf-social-"+z.id+"-icon",publishTopic:"ALF_NAVIGATE_TO_PAGE",publishPayload:{url:F,type:"FULL_PATH",target:"NEW"}}};C.push(D)}else{this.alfLog("warn","A social publishing link was configured that didn't include an 'href' parameter",z)}}else{this.alfLog("warn","A social publishing link was configured that didn't include an 'id' attribute",z)}},substituteSocialConfigTokens:function(C,A,y,z){if(z=="shareUrl"){return A}else{if(z=="displayName"){return this.currentItem.displayName}else{var B=this.message("linkshare.action."+C+"."+z,{"0":A,"1":this.currentItem.displayName});return B}}}})});