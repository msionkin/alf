define(["dojo/_base/declare","alfresco/renderers/InlineEditProperty","dijit/_OnDijitClickMixin","alfresco/core/ObjectTypeUtils","alfresco/core/CoreXhr","dojo/text!./templates/Tags.html","dojo/_base/array","dojo/_base/lang","alfresco/renderers/ReadOnlyTag","alfresco/renderers/EditTag","dojo/dom-construct","dijit/registry","dojo/on","dojo/dom-attr","dojo/dom-class","dojo/keys","dojo/_base/event","dojo/store/JsonRest","dijit/form/ComboBox","dijit/form/nls/ComboBox","dijit/form/nls/validate","dojo/store/util/QueryResults","dojo/store/util/SimpleQueryEngine","dojo/data/util/filter","dojo/aspect","dojo/html"],function(d,o,H,m,x,g,h,f,D,k,M,Q,I,P,v,C,S,A,s,O,t,c,u,J,p,E){return d([o,H,x],{cssRequirements:[{cssFile:"./css/Tags.css"}],templateString:g,postMixInProperties:function N(){this.inherited(arguments)},currentReadOnlyTags:null,getRenderedProperty:function a(V){var U=null;h.forEach(this.currentTags,f.hitch(this,"destroyTag"));this.currentTags=[];if(!m.isArray(V)){this.alfLog("warn","Expected an array value for tags",this,V)}else{h.forEach(V,f.hitch(this,"createReadOnlyTag","name","nodeRef"));U=""}return U},destroyTag:function L(U){if(typeof U.destroy==="function"){U.destroy()}},createReadOnlyTag:function R(X,U,Y,V){if(Y==null||Y[X]==null){this.alfLog("warn","No '"+X+"' attribute for tag",this,tag)}else{var W=new D({tagName:Y[X],tagValue:Y[U]});this.currentTags.push(W)}},postCreate:function B(){this.inherited(arguments);I(this.editTagsNode,"ALF_REMOVE_TAG",f.hitch(this,"onRemoveTag"));h.forEach(this.currentTags,f.hitch(this,"placeReadOnlyTag"))},placeReadOnlyTag:function y(V,U){V.placeAt(this.renderedValueNode)},onEditClick:function n(){this.inherited(arguments);h.forEach(this.currentTags,f.hitch(this,"createEditTag","tagName","tagValue"));if(this.tagStore==null){this.tagStore=new A({target:Alfresco.constants.PROXY_URI+"api/forms/picker/category/workspace/SpacesStore/tag:tag-root/children"});p.before(this.tagStore,"query",f.hitch(this,"interceptQuery"))}if(this.comboBox==null){this.comboBox=new s({store:this.tagStore,searchAttr:"name",queryExpr:"${0}"},this.editInputNode);p.before(this.comboBox,"_openResultList",f.hitch(this,"interceptResults"))}},interceptQuery:function b(W,V){var U={selectableType:"cm:category",size:"100",aspect:"cm:taggable",searchTerm:W.name};return[W,V]},interceptResults:function T(Y,Z,W){var V=Y.data.items;var U={name:new RegExp("^"+Z.name.toString()+".*$")};var X=c(u(U)(V));return[X,U,W]},createEditTag:function F(X,U,Y,V){var W=new k({tagName:Y[X],tagValue:Y[U]});W.placeAt(this.editTagsNode)},onRemoveTag:function G(U){var V=Q.byNode(U.target);if(V!=null){V.destroy()}},onPropertyUpdate:function q(V,W){E.set(this.renderedValueNode,"");h.forEach(this.currentTags,f.hitch(this,"destroyTag"));this.currentTags=[];var U=Q.findWidgets(this.editTagsNode);h.forEach(U,f.hitch(this,"createReadOnlyTag","tagName","tagValue"));h.forEach(this.currentTags,f.hitch(this,"placeReadOnlyTag"));h.forEach(U,f.hitch(this,"destroyTag"));v.remove(this.renderedValueNode,"hidden faded");v.add(this.editNode,"hidden");this.renderedValueNode.focus()},onValueEntryKeyPress:function w(V){if(V.charOrCode==C.ESCAPE){S.stop(V);this.onCancel()}else{if(V.charOrCode==C.ENTER){S.stop(V);var U=this.comboBox.get("value");if(U!=""){this.comboBox.set("value","");this.createRemoteTag(U,false)}else{this.onSave()}}else{if(V.charOrCode==C.PAGE_DOWN||V.charOrCode==C.DOWN_ARROW||V.charOrCode==C.PAGE_UP||V.charOrCode==C.UP_ARROW){S.stop(V)}}}},getCreateRemoteTagURL:function i(){return Alfresco.constants.PROXY_URI+"api/tag/workspace/SpacesStore"},getCreateRemoteTagData:function e(U){return{name:U}},createRemoteTag:function i(V,W){var U={url:this.getCreateRemoteTagURL(),method:"POST",saveTagsAfterCreate:W,data:this.getCreateRemoteTagData(V),successCallback:this.onCreateRemoteTagSuccess,failureCallback:this.onCreateRemoteTagFailure,callbackScope:this};this.serviceXhr(U)},onCreateRemoteTagSuccess:function j(V,U){this.createEditTag("name","nodeRef",V);if(U.saveTagsAfterCreate==true){this.onSave()}},onCreateRemoteTagFailure:function z(V,U){this.alfLog("error","Could not create a tag",V,U)},onSave:function K(){var U=this.comboBox.get("value");if(U!=""){this.comboBox.set("value","");this.createRemoteTag(U,true)}else{this.inherited(arguments)}},onCancel:function l(){this.inherited(arguments);this.comboBox.set("value","");var U=Q.findWidgets(this.editTagsNode);h.forEach(U,f.hitch(this,"destroyTag"))},getSaveData:function r(){var V=Q.findWidgets(this.editTagsNode);var U="";for(var W=0;W<V.length;W++){U=U+","+V[W].tagValue}if(U.length>0){U=U.substring(1)}var X={};X[this.postParam]=U;return X}})});