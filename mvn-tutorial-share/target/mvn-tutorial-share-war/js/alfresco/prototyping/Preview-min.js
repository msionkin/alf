define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dojo/text!./templates/Preview.html","alfresco/core/Core","alfresco/core/CoreXhr","dojo/dom-construct","dojo/_base/lang","dojo/json","dojo/query","dojo/NodeList-manipulate"],function(h,d,k,l,c,e,f,b,g,i){return h([d,k,c,e],{cssRequirements:[{cssFile:"./css/Preview.css"}],i18nRequirements:[{i18nFile:"./i18n/Preview.properties"}],templateString:l,postCreate:function j(){this.alfSubscribe("ALF_GENERATE_PAGE_PREVIEW",b.hitch(this,"generatePreview"))},generatePreview:function a(r){if(r!=null&&r.pageDefinition!=null){f.empty(this.previewNode);try{var o=g.parse(r.pageDefinition);var p={jsonContent:o,widgets:r.pageDefinition};this.serviceXhr({url:Alfresco.constants.URL_SERVICECONTEXT+"surf/dojo/xhr/dependencies",data:p,method:"POST",successCallback:this.updatePage,failureCallback:this.onDependencyFailure,callbackScope:this})}catch(q){this.alfLog("error","An error occurred parsing the JSON",q,this)}}else{this.alfLog("warn","A request was made to preview a page definition, but no 'pageDefinition' was provided",r,this)}},updatePage:function m(p,o){for(var s in p.cssMap){i("head").append('<link rel="stylesheet" type="text/css" href="'+appContext+p.cssMap[s]+'" media="'+s+'">')}for(var r in p.i18nMap){if(typeof window[p.i18nGlobalObject].messages.scope[r]=="undefined"){window[p.i18nGlobalObject].messages.scope[r]=p.i18nMap[r]}else{b.mixin(window[p.i18nGlobalObject].messages.scope[r],p.i18nMap[r])}}var q=[Alfresco.constants.URL_RESCONTEXT+p.javaScript];require(q,b.hitch(this,"processWidgets",o.data.jsonContent.widgets,this.previewNode))},onDependencyFailure:function n(p,o){this.alfLog("error","An error occurred requesting the XHR dependencies",p,o)}})});