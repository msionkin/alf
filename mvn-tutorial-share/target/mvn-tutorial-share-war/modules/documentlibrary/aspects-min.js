(function(){var h=YAHOO.util.Dom,o=YAHOO.util.Event;var e=Alfresco.util.encodeHTML;Alfresco.module.DoclibAspects=function(p){Alfresco.module.DoclibAspects.superclass.constructor.call(this,p,["button","container","datasource","datatable"]);this.eventGroup=p;this.currentValues=[];this.selectedValues={};return this};YAHOO.extend(Alfresco.module.DoclibAspects,Alfresco.module.SimpleDialog,{currentValues:null,selectedValues:null,setOptions:function g(p){Alfresco.module.DoclibAspects.superclass.setOptions.call(this,{width:"50em",templateUrl:Alfresco.constants.URL_SERVICECONTEXT+"modules/documentlibrary/aspects",doBeforeDialogShow:{fn:this.doBeforeDialogShow,obj:null,scope:this},doBeforeAjaxRequest:{fn:this.doBeforeAjaxRequest,obj:null,scope:this}});this.options=YAHOO.lang.merge(this.options,p);return this},renderItem:function b(r,q){var p=function(w,y,x){var t="";if(w.toLowerCase()=="icon"){var v="",s="",u;if(x&&x.length>0){u=x.split(" ");v=' width="'+u[0]+'"';if(u.length>1){s=' height="'+u[1]+'"'}}t='<img src="'+y+'"'+v+s+' alt="'+e(r.name)+'" title="'+e(r.name)+'" />'}else{t=e(y)}return t};return YAHOO.lang.substitute(q,r,p)},i18n:function m(p,q){return this.msg("aspect."+p.replace(":","_"))},doBeforeDialogShow:function j(q,s,r){var p='<span class="light">'+e(this.options.file.displayName)+"</span>";h.get(this.id+"-title").innerHTML=this.msg("title",p);if(!this.modules.actions){this.modules.actions=new Alfresco.module.DoclibActions(Alfresco.doclib.MODE_REPOSITORY)}this._createAspectsControls();this._requestAspectData();this.widgets.okButton.set("disabled",false);this.widgets.cancelButton.set("disabled",false)},doBeforeAjaxRequest:function a(s){var q=function r(u){this.hide();Alfresco.util.PopupManager.displayMessage({text:this.msg(u.json.overallSuccess?"message.aspects.success":"message.aspects.failure")});if(u.json.results[0].tagScope){}};var t=function p(u){this.hide();Alfresco.util.PopupManager.displayMessage({text:this.msg("message.aspects.failure")})};this.modules.actions.genericAction({success:{event:{name:"metadataRefresh",obj:{highlightFile:this.options.file.name}},callback:{fn:q,scope:this}},failure:{callback:{fn:t,scope:this}},webscript:{method:Alfresco.util.Ajax.POST,name:"aspects/node/{nodeRef}",params:{nodeRef:this.options.file.jsNode.nodeRef.uri}},config:{requestContentType:Alfresco.util.Ajax.JSON,dataObj:{added:this.getAddedValues(),removed:this.getRemovedValues()}}});return false},getAddedValues:function n(){var r=[],p=Alfresco.util.arrayToObject(this.currentValues);for(var q in this.selectedValues){if(this.selectedValues.hasOwnProperty(q)){if(!(q in p)){r.push(q)}}}return r},getRemovedValues:function l(){var r=[],p=Alfresco.util.arrayToObject(this.currentValues);for(var q in p){if(p.hasOwnProperty(q)){if(!(q in this.selectedValues)){r.push(q)}}}return r},_createAspectsControls:function k(){var w=this;var u=function u(A,z,B,C){h.setStyle(A.parentNode,"width",B.width+"px");A.innerHTML=w.renderItem(z.getData(),"<div>{icon 16 16}</div>")};var x=function x(A,z,B,C){A.innerHTML=w.renderItem(z.getData(),'<h3 class="name">{name}</h3>')};var p=function p(A,z,B,C){h.setStyle(A.parentNode,"width",B.width+"px");if(z.getData("canAdd")){A.innerHTML='<a href="#" class="add-item add-'+w.eventGroup+'" title="'+w.msg("button.add")+'"><span class="addIcon">&nbsp;</span></a>'}};var s=function s(A,z,B,C){h.setStyle(A.parentNode,"width",B.width+"px");if(z.getData("canRemove")){A.innerHTML='<a href="#" class="remove-item remove-'+w.eventGroup+'" title="'+w.msg("button.remove")+'"><span class="removeIcon">&nbsp;</span></a>'}};this.widgets.dataSourceLeft=new YAHOO.util.DataSource([],{responseType:YAHOO.util.DataSource.TYPE_JSARRAY});var v=[{key:"icon",label:"icon",sortable:false,formatter:u,width:10},{key:"name",label:"name",sortable:false,formatter:x},{key:"id",label:"add",sortable:false,formatter:p,width:16}];this.widgets.dataTableLeft=new YAHOO.widget.DataTable(this.id+"-left",v,this.widgets.dataSourceLeft,{MSG_EMPTY:this.msg("label.loading")});var r=function q(C,B){var z=YAHOO.Bubbling.getOwnerByTagName(B[1].anchor,"div");if(z!==null){var E=B[1].target,D=E.offsetParent,A=w.widgets.dataTableLeft.getRecord(D);if(A){w.widgets.dataTableRight.addRow(A.getData());w.selectedValues[A.getData("id")]=A;w.widgets.dataTableLeft.deleteRow(D)}}return true};YAHOO.Bubbling.addDefaultAction("add-"+this.eventGroup,r);this.widgets.dataSourceRight=new YAHOO.util.DataSource([],{responseType:YAHOO.util.DataSource.TYPE_JSARRAY});var t=[{key:"icon",label:"icon",sortable:false,formatter:u,width:10},{key:"name",label:"name",sortable:false,formatter:x},{key:"id",label:"remove",sortable:false,formatter:s,width:16}];this.widgets.dataTableRight=new YAHOO.widget.DataTable(this.id+"-right",t,this.widgets.dataSourceRight,{MSG_EMPTY:this.msg("label.loading")});var y=function y(C,B){var z=YAHOO.Bubbling.getOwnerByTagName(B[1].anchor,"div");if(z!==null){var E=B[1].target,D=E.offsetParent,A=w.widgets.dataTableRight.getRecord(D);if(A){w.widgets.dataTableLeft.addRow(A.getData());delete w.selectedValues[A.getData("id")];w.widgets.dataTableRight.deleteRow(D)}}return true};YAHOO.Bubbling.addDefaultAction("remove-"+this.eventGroup,y)},_requestAspectData:function f(){this.selectedValues={};Alfresco.util.Ajax.request({method:"GET",url:Alfresco.constants.PROXY_URI+"slingshot/doclib/aspects/node/"+this.options.file.jsNode.nodeRef.uri,successCallback:{fn:this._requestAspectDataSuccess,scope:this},failureCallback:{fn:this._requestAspectDataFailure,scope:this}})},_requestAspectDataFailure:function i(){this.widgets.dataTableLeft.set("MSG_EMPTY",this.msg("label.load-failure"));this.widgets.dataTableRight.set("MSG_EMPTY",this.msg("label.load-failure"))},_requestAspectDataSuccess:function c(s){this.currentValues={};if(typeof s.json!="undefined"){var r=s.json.current,p=Alfresco.util.arrayToObject(r),C=this.options.visible,B=Alfresco.util.arrayToObject(C),y=this.options.addable,t=this.options.removeable,u,A;this.currentValues=r;if(y.length===0){y=C.slice(0)}this._googleDocsFilter(y);if(t.length===0){t=C.slice(0)}var w=Alfresco.util.arrayToObject(y),q=Alfresco.util.arrayToObject(t);var x,z,v;for(u=0,A=r.length;u<A;u++){x=r[u];v={id:x,icon:Alfresco.constants.URL_RESCONTEXT+"components/images/aspect-16.png",name:this.i18n(x),canAdd:x in w,canRemove:x in q};if(x in B){this.widgets.dataTableRight.addRow(v)}this.selectedValues[x]=v}for(u=0,A=y.length;u<A;u++){z=y[u];if((z in B)&&!(z in p)){this.widgets.dataTableLeft.addRow({id:z,icon:Alfresco.constants.URL_RESCONTEXT+"components/images/aspect-16.png",name:this.i18n(z),canAdd:true,canRemove:true})}}this.widgets.dataTableLeft.set("MSG_EMPTY",this.msg("label.no-addable"));this.widgets.dataTableRight.set("MSG_EMPTY",this.msg("label.no-current"));this.widgets.dataTableLeft.render();this.widgets.dataTableRight.render()}},_googleDocsFilter:function d(u){var r={"text/plain":true,"application/msword":true,"application/vnd.ms-excel":true,"application/vnd.ms-powerpoint":true},p=this.options.file.node.mimetype;if(!r.hasOwnProperty(p)){var q=function q(y,x,w){var v=y.slice((w||x)+1||y.length);y.length=x<0?y.length+x:x;return y.push.apply(y,v)};for(var s=0,t=u.length;s<t;s++){if(u[s]=="gd:googleEditable"){q(u,s);break}}}}})})();var doclibAspects=new Alfresco.module.DoclibAspects("null");